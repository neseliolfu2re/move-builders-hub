<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Move Builders Hub ‚Ä¢ On-Chain Move Learning</title>
	<meta name="color-scheme" content="dark light" />
	<!-- PWA Meta Tags -->
	<meta name="theme-color" content="#82ffa1">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-title" content="Move Builders Hub">
	<link rel="manifest" href="manifest.json">
	<link rel="apple-touch-icon" href="logo.png">
	<script type="text/javascript" src="https://gc.kis.v2.scr.kaspersky-labs.com/FD126C42-EBFA-4E12-B309-BB3FDD723AC1/main.js?attr=mOrX-bGrCd2ojWTI94dLZLQXd0p6VX2nlfhNmWDlzTu8DOK_rxjPU8OBRLuCZFuLh3p8O9MEaFBrAe-iHHUHx_QAsWKSzJkhDmfGp72q4VyONaBmp7xKnN72LC8VkvniWDAxiXR9et8jbV4BfJJc71SFF1MaVe5OJsb8yTEzUZ-tGI1kHzW85c-qr6KeNPoFJ63RW2TiFXdFKFB9DKpPtQ" charset="UTF-8"></script><link rel="stylesheet" crossorigin="anonymous" href="https://gc.kis.v2.scr.kaspersky-labs.com/E3E8934C-235A-4B0E-825A-35A08381A191/abn/main.css?attr=aHR0cHM6Ly9tdC1zb25vbWEuZ3V6ZWxob3N0aW5nLmNvbToyMDgzL2Nwc2VzczQ0MDgzMTc2NzQvZG93bmxvYWQ_c2tpcGVuY29kZT0xJmZpbGU9JTJmaG9tZSUyZmZ1cmVvcmclMmZtb3ZlYnVpbGRlcnNodWIueHl6JTJmaW5kZXguaHRtbA"/><style>
		:root { color-scheme: dark; }
		html, body { height: 100%; }
		* { box-sizing: border-box; }
		body {
			margin: 0;
			font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
			background: #000;
			color: #fff;
		}
		.container { width: min(1200px, 92vw); margin: 0 auto; padding: 20px; }
		.header { display: grid; gap: 12px; text-align: center; padding: 40px 0 24px; }
		h1 { font-size: clamp(28px, 4vw, 40px); margin: 0; }
		.subtitle { color: #bdbdbd; margin: 0 auto; max-width: 800px; }
		.badges { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; margin-top: 8px; }
		.badge { padding: 6px 12px; border-radius: 999px; border: 1px solid #2a2a2a; background:#0f0f0f; font-size: 12px; color:#e5e5e5; }
		.ctaRow { display:flex; gap:12px; justify-content:center; flex-wrap:wrap; margin-top: 14px; }
		.btn { appearance:none; border:1px solid #fff; background:#fff; color:#000; padding:12px 16px; border-radius:10px; font-weight:600; cursor:pointer; }
		.btn.secondary { background:transparent; color:#fff; border-color:#fff; }
		.note { color:#ffd788; font-size: 12px; margin-top: 6px; }
		.divider { height:1px; background:#1f1f1f; margin: 24px 0; }

		.grid { display:grid; gap:16px; grid-template-columns: repeat(auto-fit, minmax(260px,1fr)); }
		.card { background:#0f0f0f; border:1px solid #222; border-radius:14px; padding:18px; }
		.card h3 { margin:0 0 8px 0; font-size:18px; }
		.card p { margin:0; color:#cfcfcf; line-height:1.5; }

		.sectionTitle { font-size:20px; margin: 0 0 12px 0; }
		.row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
		.kpi { text-align:center; padding:14px; border:1px solid #222; border-radius:12px; background:#0f0f0f; }
		.kpi .num { font-size:20px; font-weight:700; }
		.kpi .lbl { color:#bdbdbd; font-size:12px; }

		.footer { text-align:center; color:#8a8a8a; font-size:12px; padding: 24px 0 40px; }

		/* Modal */
		.modalBack { position:fixed; inset:0; background:rgba(0,0,0,.8); display:none; place-items:center; z-index:1000; }
		.modal { width:min(860px,94vw); max-height:80vh; overflow:auto; background:#0f0f0f; border:1px solid #2a2a2a; border-radius:16px; padding:20px; }
		.modal h2 { margin:0 0 10px 0; font-size:20px; }
		.modal .qgrid { display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(240px,1fr)); margin-top: 8px; }
		.qcard { border:1px solid #222; border-radius:12px; padding:12px; background:#111; }
		.qtop { display:flex; align-items:center; justify-content:space-between; gap:8px; }
		.qdiff { font-size:12px; padding:4px 8px; border:1px solid #333; border-radius:999px; color:#e5e5e5; }
		.qdesc { color:#cfcfcf; font-size:14px; margin:10px 0; line-height:1.5; }
		.qrow { display:flex; align-items:center; justify-content:space-between; }
		.qreward { color:#82ffa1; font-weight:700; }
		.linkish { color:#fff; text-decoration:none; }

		/* Profile chips */
		.chips { display:flex; flex-wrap:wrap; gap:6px; margin-top:8px; }
		.chip { font-size:12px; padding:4px 8px; border:1px solid #333; border-radius:999px; color:#e5e5e5; }

		/* Loading spinner */
		.spinner { width:16px; height:16px; border:2px solid #333; border-top:2px solid #82ffa1; border-radius:50%; animation:spin 1s linear infinite; display:inline-block; margin-right:8px; }
		@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
		.btn.loading { opacity:0.7; cursor:not-allowed; }

		/* Force 3-3 layout on desktop and center */
		@media (min-width: 900px) {
			.grid { grid-template-columns: repeat(3, 1fr); justify-items: stretch; }
		}
	</style>
</head>
<body>
	<!-- Top Navigation with Wallet -->
	<nav style="position: fixed; top: 0; right: 0; z-index: 1000; padding: 16px;">
		<button class="btn" id="connectWallet" style="display:none; font-size:12px; padding:8px 12px;">Connect Wallet</button>
		<div id="walletInfo" style="display:none; background:#0f0f0f; border:1px solid #2a2a2a; border-radius:8px; padding:8px; text-align:center; position:relative; cursor:pointer;" onclick="toggleUserDropdown()">
			<div style="color:#82ffa1; font-size:11px; margin-bottom:4px;">üü¢ Connected</div>
			<div id="userName" style="color:#fff; font-size:12px; margin-bottom:2px; font-weight:bold;"></div>
			<div id="walletAddress" style="font-family:monospace; font-size:10px; color:#cfcfcf; margin-bottom:6px;"></div>
			<button class="btn secondary" id="disconnectWallet" style="font-size:10px; padding:4px 8px;" onclick="event.stopPropagation(); disconnectWallet();">Disconnect</button>
			
			<!-- User Profile Dropdown -->
			<div id="userProfileDropdown" style="display:none; position:absolute; top:100%; right:0; background:#1a1a1a; border:1px solid #333; border-radius:8px; padding:8px; margin-top:4px; min-width:200px; box-shadow:0 4px 12px rgba(0,0,0,0.3);">
				<button class="btn secondary" id="viewMyProfileBtn" style="width:100%; font-size:11px; margin-bottom:4px;">üë§ View My Profile</button>
				<button class="btn secondary" id="editProfileBtn" style="width:100%; font-size:11px; margin-bottom:4px;">‚úèÔ∏è Edit Profile</button>
				<button class="btn secondary" id="getReferralLinkBtn" style="width:100%; font-size:11px; margin-bottom:4px;">üîó Get Referral Link</button>
				<button class="btn secondary" id="socialLinksBtn" style="width:100%; font-size:11px; margin-bottom:4px;">üì± Social Links</button>
				<button class="btn secondary" id="closeDropdown" style="width:100%; font-size:11px; background:#333;">‚úï Close</button>
			</div>
		</div>
	</nav>

	<!-- Logo Section -->
	<div class="container" style="text-align: center; padding: 20px 20px 10px;">
		<img src="logo.png" alt="Move Builders Hub" style="width: 160px; height: auto; max-width: 100%; margin-bottom: -8px;">
	</div>

	<header class="container header">
		<h1>Move Builders Hub ‚Ä¢ On-Chain Move Learning</h1>
		<p class="subtitle">A collaboration-first platform that tracks Move learning on-chain with quests, mentorship, collaboration sessions, sponsor rewards, and analytics.</p>
		<div class="badges">
			<span class="badge">Aptos Testnet</span>
			<span class="badge">Move Language</span>
			<span class="badge">On-Chain Proof</span>
			<span class="badge">Mentorship</span>
			<span class="badge">Collaboration</span>
			<span class="badge">Sponsors & Rewards</span>
		</div>
		<div class="ctaRow">
			<button class="btn" id="exploreQuests">Explore Quests</button>
			<button class="btn secondary" id="viewStats">üéØ Quest Progress</button>
			<button class="btn secondary" id="myDashboard" style="display:none;">My Dashboard</button>
		</div>
		<!-- Referral Section (hidden - moved to profile) -->
		<div id="referralSection" style="display:none; margin-top:12px;">
			<button class="btn secondary" id="getReferralLink" style="font-size:12px;">üîó Get Referral Link</button>
		</div>
	</header>

	<main class="container">
		<section>
			<h2 class="sectionTitle">Highlights</h2>
			<div class="grid">
				<div class="card" onclick="scrollToQuests()" style="cursor:pointer; transition:all 0.2s ease;" onmouseover="this.style.borderColor='#82ffa1'" onmouseout="this.style.borderColor='#222'">
					<h3>üéØ Quest System</h3>
					<p>Practice with leveled Move quests and record progress on-chain.</p>
					<div style="position:absolute; top:18px; right:18px; color:#82ffa1;">‚Üí</div>
				</div>
				<div class="card" onclick="scrollToMentorship()" style="cursor:pointer; transition:all 0.2s ease;" onmouseover="this.style.borderColor='#82ffa1'" onmouseout="this.style.borderColor='#222'">
					<h3>üë• Mentorship</h3>
					<p>Match with experienced Move devs, schedule 1:1 sessions, grow faster.</p>
					<div style="position:absolute; top:18px; right:18px; color:#82ffa1;">‚Üí</div>
				</div>
				<div class="card" onclick="scrollToCollaboration()" style="cursor:pointer; transition:all 0.2s ease;" onmouseover="this.style.borderColor='#82ffa1'" onmouseout="this.style.borderColor='#222'">
					<h3>ü§ù Collaboration</h3>
					<p>Pair-program and join mini-hackathons to solve real problems together.</p>
					<div style="position:absolute; top:18px; right:18px; color:#82ffa1;">‚Üí</div>
				</div>
				<div class="card" onclick="scrollToRewards()" style="cursor:pointer; transition:all 0.2s ease;" onmouseover="this.style.borderColor='#82ffa1'" onmouseout="this.style.borderColor='#222'">
					<h3>üèÜ Rewards & Sponsors</h3>
					<p>Complete sponsor quests and earn rewards. Sustainable, tokenless model.</p>
					<div style="position:absolute; top:18px; right:18px; color:#82ffa1;">‚Üí</div>
				</div>
				<div class="card" onclick="scrollToAnalytics()" style="cursor:pointer; transition:all 0.2s ease;" onmouseover="this.style.borderColor='#82ffa1'" onmouseout="this.style.borderColor='#222'">
					<h3>üìä Analytics</h3>
					<p>DAU, quest completion rate, and average difficulty over time.</p>
					<div style="position:absolute; top:18px; right:18px; color:#82ffa1;">‚Üí</div>
				</div>
				<div class="card" onclick="scrollToProfiles()" style="cursor:pointer; transition:all 0.2s ease;" onmouseover="this.style.borderColor='#82ffa1'" onmouseout="this.style.borderColor='#222'">
					<h3>üîê Builder Profiles</h3>
					<p>Meet experienced Move developers and view their achievements.</p>
					<div style="position:absolute; top:18px; right:18px; color:#82ffa1;">‚Üí</div>
				</div>
			</div>
		</section>

		<div class="divider"></div>

		<section>
			<h2 class="sectionTitle">Builder Profiles</h2>
			<div class="grid" id="profilesGrid"></div>
		
		<!-- Chat Modal -->
		<div id="chatModal" class="modalBack">
			<div class="modal" style="max-width:800px; height:600px; display:flex; flex-direction:column;">
				<div style="display:flex; align-items:center; justify-content:space-between; gap:8px; border-bottom:1px solid #333; padding-bottom:12px;">
					<div>
						<h2 id="chatTitle">üí¨ Chat</h2>
						<div id="chatGasInfo" style="font-size:12px; color:#8a8a8a;">Gas Fee: Loading...</div>
					</div>
					<a class="linkish" href="#" id="closeChat">Close ‚úï</a>
				</div>
				
				<div id="chatMessages" style="flex:1; overflow-y:auto; padding:16px; background:#0f0f0f; border-radius:8px; margin:12px 0;">
					<!-- Messages will be loaded here -->
				</div>
				
				<div style="display:flex; gap:8px; align-items:center;">
					<input type="text" id="messageInput" placeholder="Type your message..." style="flex:1; padding:12px; background:#1a1a1a; border:1px solid #333; border-radius:6px; color:#fff;">
					<button class="btn" onclick="sendMessage()" id="sendMessageBtn">Send</button>
				</div>
				
				<div style="display:flex; gap:8px; margin-top:8px; font-size:12px; color:#8a8a8a;">
					<span id="messageCount">0 messages</span>
					<span>‚Ä¢</span>
					<span id="gasFeeDisplay">Gas: 0.001 APT</span>
					<span>‚Ä¢</span>
					<span id="networkStatus">Network: Normal</span>
				</div>
				
				<div id="transactionInfo" style="margin-top:8px; padding:8px; background:#1a1a1a; border-radius:6px; font-size:11px; color:#8a8a8a; display:none;">
					<div>üí≥ <strong>Transaction Required:</strong> Each message requires a small gas fee to prevent spam</div>
					<div style="margin-top:4px;">üîí <strong>Secure:</strong> Your wallet will ask for approval before sending</div>
				</div>
			</div>
		</div>
		</section>

		<div class="divider"></div>

		<section>
			<h2 class="sectionTitle">Live Analytics Dashboard</h2>
			<div class="grid">
				<div class="kpi"><div class="num" id="activeDevelopers">127</div><div class="lbl">Active Developers</div></div>
				<div class="kpi"><div class="num" id="completedQuests">89</div><div class="lbl">Completed Quests</div></div>
				<div class="kpi"><div class="num" id="onChainTx">156</div><div class="lbl">On-Chain Transactions</div></div>
			</div>
			
			<div style="display:grid; gap:16px; grid-template-columns: repeat(auto-fit, minmax(300px,1fr)); margin-top:16px;">
				<div style="background:#0f0f0f; border:1px solid #222; border-radius:12px; padding:16px;">
					<h3 style="margin:0 0 12px 0;">Quest Completion Trend</h3>
					<canvas id="questChart" width="300" height="120"></canvas>
				</div>
				<div style="background:#0f0f0f; border:1px solid #222; border-radius:12px; padding:16px;">
					<h3 style="margin:0 0 12px 0;">Top Builders</h3>
					<div id="topBuilders">
						<div style="display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid #2a2a2a;">
							<span>@nese</span><span style="color:#82ffa1;">35 quests</span>
						</div>
						<div style="display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid #2a2a2a;">
							<span>@dilek</span><span style="color:#82ffa1;">29 quests</span>
						</div>
						<div style="display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid #2a2a2a;">
							<span>@selina</span><span style="color:#82ffa1;">22 quests</span>
						</div>
						<div style="display:flex; justify-content:space-between; padding:6px 0;">
							<span>@deniz</span><span style="color:#82ffa1;">20 quests</span>
						</div>
					</div>
				</div>
			</div>
		</section>

		<div class="divider"></div>

		<section>
			<h2 class="sectionTitle">Mentorship & Collaboration</h2>
			<div class="grid">
				<div class="card">
					<h3>Schedule Mentorship</h3>
					<p>Create your profile and goals, match with mentors via calendar.</p>
					<button class="btn" id="findMentorBtn">Find Mentor</button>
				</div>
				<div class="card">
					<h3>Pair Programming</h3>
					<p>Team up on specific quests, exchange knowledge and code together.</p>
					<button class="btn secondary" id="joinPairBtn">Join Session</button>
				</div>
				<div class="card">
					<h3>Mini-Hackathons</h3>
					<p>Sponsor-supported, time-boxed events for focused building.</p>
					<button class="btn" id="viewHackathonsBtn">View Events</button>
				</div>
			</div>
			
			<!-- Active Collaborations -->
			<div style="margin-top:20px;">
				<h3>üî• Active Collaborations</h3>
				<div class="grid">
					<div class="card">
						<h4>DeFi Protocol Build</h4>
						<p>Building a lending protocol in Move. <strong>3/5 spots filled</strong></p>
						<div class="chips" style="margin-bottom:12px;">
							<span class="chip">Advanced</span>
							<span class="chip">2 weeks</span>
							<span class="chip">Reward: 5 APT</span>
						</div>
						<button class="btn" onclick="joinCollaboration('defi-protocol')" style="width:100%;">Join Team</button>
					</div>
					<div class="card">
						<h4>NFT Marketplace</h4>
						<p>Creating an NFT trading platform. <strong>2/4 spots filled</strong></p>
						<div class="chips" style="margin-bottom:12px;">
							<span class="chip">Intermediate</span>
							<span class="chip">3 weeks</span>
							<span class="chip">Reward: 3 APT</span>
						</div>
						<button class="btn" onclick="joinCollaboration('nft-marketplace')" style="width:100%;">Join Team</button>
					</div>
					<div class="card">
						<h4>Move Learning Game</h4>
						<p>Gamified Move education platform. <strong>1/3 spots filled</strong></p>
						<div class="chips" style="margin-bottom:12px;">
							<span class="chip">Beginner</span>
							<span class="chip">1 week</span>
							<span class="chip">Reward: 1 APT</span>
						</div>
						<button class="btn" onclick="joinCollaboration('learning-game')" style="width:100%;">Join Team</button>
					</div>
				</div>
			</div>
		</section>

		<div class="divider"></div>

		<section>
			<h2 class="sectionTitle">Rewards & Sponsors</h2>
			<div class="grid">
				<div class="card">
					<h3>Sponsor Pools</h3>
					<p>Sponsors open themed pools; complete quests and earn points.</p>
					<button class="btn" id="viewSponsorPools">View Active Pools</button>
				</div>
				<div class="card">
					<h3>Fair Evaluation</h3>
					<p>Collaboration over competition. No exploit-chasing mechanics.</p>
					<button class="btn secondary" id="leaderboardBtn">View Leaderboard</button>
				</div>
				<div class="card">
					<h3>Transparency</h3>
					<p>On-chain records make progress and rewards verifiable.</p>
					<button class="btn secondary" id="verifyRewards">Verify My Rewards</button>
				</div>
			</div>
			
			<!-- Active Sponsor Pools -->
			<div style="margin-top:20px;">
				<h3>üí∞ Active Sponsor Pools</h3>
				<div class="grid">
					<div class="card">
						<h4>üè¶ Aptos Foundation Pool</h4>
						<p>Focus on core Move development and education</p>
						<div class="chips">
							<span class="chip">Pool: 1000 APT</span>
							<span class="chip">127 Participants</span>
							<span class="chip">Ends: Dec 31</span>
						</div>
						<div style="background:#1a1a1a; height:6px; border-radius:3px; margin:8px 0;">
							<div style="background:#82ffa1; height:100%; width:65%; border-radius:3px;"></div>
						</div>
						<small style="display:block; margin-bottom:12px;">65% distributed</small>
						<button class="btn" onclick="joinSponsorPool('aptos-foundation')" style="width:100%;">Join Pool</button>
					</div>
					<div class="card">
						<h4>üîä Decibel Pool</h4>
						<p>Infrastructure and developer tooling focus</p>
						<div class="chips">
							<span class="chip">Pool: 750 APT</span>
							<span class="chip">92 Participants</span>
							<span class="chip">Ends: Nov 30</span>
						</div>
						<div style="background:#1a1a1a; height:6px; border-radius:3px; margin:8px 0;">
							<div style="background:#82ffa1; height:100%; width:45%; border-radius:3px;"></div>
						</div>
						<small style="display:block; margin-bottom:12px;">45% distributed</small>
						<button class="btn" onclick="joinSponsorPool('decibel')" style="width:100%;">Join Pool</button>
					</div>
					<div class="card">
						<h4>‚ö° Shelby Protocol Pool</h4>
						<p>Cross-chain and interoperability solutions</p>
						<div class="chips" style="margin-bottom:8px;">
							<span class="chip">Pool: 400 APT</span>
							<span class="chip">67 Participants</span>
							<span class="chip">Ends: Jan 15</span>
						</div>
						<div style="background:#1a1a1a; height:6px; border-radius:3px; margin:8px 0;">
							<div style="background:#82ffa1; height:100%; width:30%; border-radius:3px;"></div>
						</div>
						<small style="display:block; margin-bottom:12px;">30% distributed</small>
						<button class="btn" onclick="joinSponsorPool('shelby-protocol')" style="width:100%;">Join Pool</button>
					</div>
				</div>
			</div>
		</section>
	</main>

	<footer class="footer container">
		Move Builders Hub ‚Ä¢ Aptos Testnet ‚Ä¢ ¬© 2025
	</footer>

	<!-- Quests Modal -->
	<div id="questsModal" class="modalBack">
		<div class="modal">
			<div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
				<h2>üöÄ Available Move Quests</h2>
				<a class="linkish" href="#" id="closeModal">Close ‚úï</a>
			</div>
			<p class="subtitle">Interactive Move learning quests with on-chain completion tracking.</p>
			<div class="qgrid" id="qgrid"></div>
		</div>
	</div>

	<!-- Profile Modal -->
	<div id="profileModal" class="modalBack">
		<div class="modal">
			<div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
				<h2 id="pm_name">Builder Profile</h2>
				<a class="linkish" href="#" id="pm_close">Close ‚úï</a>
			</div>
			
			<!-- Avatar Section -->
			<div id="pm_avatar" style="text-align:center; margin:20px 0;">
				<!-- Avatar upload button for own profile -->
				<div id="avatarUploadSection" style="display:none; margin-bottom:15px;">
					<input type="file" id="avatarUpload" accept="image/*" style="display:none;">
					<button class="btn secondary" onclick="document.getElementById('avatarUpload').click()" style="font-size:11px;">üì∑ Upload Avatar</button>
				</div>
			</div>
			
			<!-- Username Section -->
			<div style="text-align:center; margin:10px 0;">
				<h2 id="pm_username" style="color:#82ffa1; margin:0; font-size:18px;"></h2>
				<p id="pm_handle" style="color:#888; margin:5px 0 0 0; font-size:12px;"></p>
			</div>
			
			<!-- Bio Section -->
			<div style="background:#1a1a1a; padding:15px; border-radius:8px; margin:15px 0;">
				<h3 style="color:#82ffa1; margin:0 0 10px 0; font-size:14px;">üìù Bio</h3>
				<p id="pm_bio" class="subtitle" style="margin:0; line-height:1.5;"></p>
			</div>
			
			<!-- Skills Section -->
			<div style="background:#1a1a1a; padding:15px; border-radius:8px; margin:15px 0;">
				<h3 style="color:#82ffa1; margin:0 0 10px 0; font-size:14px;">üõ†Ô∏è Skills</h3>
				<div class="chips" id="pm_skills"></div>
			</div>
			
			<!-- Status Section -->
			<div style="background:#1a1a1a; padding:15px; border-radius:8px; margin:15px 0;">
				<h3 style="color:#82ffa1; margin:0 0 10px 0; font-size:14px;">üìä Status</h3>
				<div class="row" style="margin:0;">
					<span id="pm_avail" class="badge"></span>
					<span id="pm_tz" class="badge"></span>
				</div>
			</div>
			
			<!-- Social Links Section -->
			<div style="background:#1a1a1a; padding:15px; border-radius:8px; margin:15px 0;">
				<h3 style="color:#82ffa1; margin:0 0 10px 0; font-size:14px;">üîó Social Links</h3>
				<div id="pm_social" style="display:flex; gap:10px; flex-wrap:wrap;"></div>
			</div>
			<div style="margin-top:12px" id="pm_links" class="row"></div>
			<div class="divider"></div>
			<div class="row" style="gap:16px">
				<div class="kpi"><div class="num" id="pm_completed">0</div><div class="lbl">Completed</div></div>
				<div class="kpi"><div class="num" id="pm_streak">0</div><div class="lbl">Streak (days)</div></div>
			</div>
			<div style="margin-top:12px">
				<h3 style="margin:0 0 8px 0; font-size:16px">Badges</h3>
				<div class="chips" id="pm_badges"></div>
			</div>
		</div>
	</div>

	<!-- Create Profile Modal -->
	<div id="createProfileModal" class="modalBack">
		<div class="modal" style="max-width:500px;">
			<div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
				<h2>üöÄ Create Your Profile</h2>
				<a class="linkish" href="#" id="closeCreateProfile">Close ‚úï</a>
			</div>
			
			<div style="margin:16px 0;">
				<h3 style="margin:0 0 8px 0;">Avatar</h3>
				
				<!-- Upload Custom Avatar -->
				<div style="margin-bottom:15px; text-align:center;">
					<input type="file" id="customAvatarUpload" accept="image/*" style="display:none;">
					<button class="btn secondary" onclick="document.getElementById('customAvatarUpload').click()" style="font-size:12px; margin-bottom:10px;">üì∑ Upload Custom Avatar</button>
					<div id="customAvatarPreview" style="display:none; margin:10px 0;">
						<img id="customAvatarImg" style="width:60px; height:60px; border-radius:50%; border:2px solid #82ffa1;">
					</div>
				</div>
				
				<!-- Or choose from emojis -->
				<p style="margin:10px 0 8px 0; font-size:12px; color:#888;">Or choose from emojis:</p>
				<div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:8px; margin:8px 0;">
					<div class="avatar-option" data-avatar="üßë‚Äçüíª" onclick="selectAvatar('üßë‚Äçüíª')" style="font-size:24px; padding:8px; text-align:center; border:2px solid #333; border-radius:8px; cursor:pointer;">üßë‚Äçüíª</div>
					<div class="avatar-option" data-avatar="üë®‚Äçüíª" onclick="selectAvatar('üë®‚Äçüíª')" style="font-size:24px; padding:8px; text-align:center; border:2px solid #333; border-radius:8px; cursor:pointer;">üë®‚Äçüíª</div>
					<div class="avatar-option" data-avatar="üë©‚Äçüíª" onclick="selectAvatar('üë©‚Äçüíª')" style="font-size:24px; padding:8px; text-align:center; border:2px solid #333; border-radius:8px; cursor:pointer;">üë©‚Äçüíª</div>
					<div class="avatar-option" data-avatar="üöÄ" onclick="selectAvatar('üöÄ')" style="font-size:24px; padding:8px; text-align:center; border:2px solid #333; border-radius:8px; cursor:pointer;">üöÄ</div>
				</div>
				
				<h3 style="margin:16px 0 8px 0;">Username</h3>
				<input type="text" id="usernameInput" placeholder="Your username..." style="width:100%; padding:10px; background:#1a1a1a; border:1px solid #333; border-radius:6px; color:#fff;">
				
				<h3 style="margin:16px 0 8px 0;">Bio</h3>
				<textarea id="bioInput" placeholder="Tell us about yourself..." style="width:100%; height:60px; padding:10px; background:#1a1a1a; border:1px solid #333; border-radius:6px; color:#fff; resize:vertical;"></textarea>
				
				<h3 style="margin:16px 0 8px 0;">Email *</h3>
				<input type="email" id="emailInput" placeholder="your@email.com" style="width:100%; padding:10px; background:#1a1a1a; border:1px solid #333; border-radius:6px; color:#fff;">
				
				<h3 style="margin:16px 0 8px 0;">Skills (Select all that apply)</h3>
				<div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap:8px; margin:8px 0;">
					<label style="display:flex; align-items:center; gap:6px; font-size:14px;">
						<input type="checkbox" name="skills" value="Move"> Move
					</label>
					<label style="display:flex; align-items:center; gap:6px; font-size:14px;">
						<input type="checkbox" name="skills" value="Rust"> Rust
					</label>
					<label style="display:flex; align-items:center; gap:6px; font-size:14px;">
						<input type="checkbox" name="skills" value="Smart Contracts"> Smart Contracts
					</label>
					<label style="display:flex; align-items:center; gap:6px; font-size:14px;">
						<input type="checkbox" name="skills" value="DeFi"> DeFi
					</label>
					<label style="display:flex; align-items:center; gap:6px; font-size:14px;">
						<input type="checkbox" name="skills" value="Security"> Security
					</label>
					<label style="display:flex; align-items:center; gap:6px; font-size:14px;">
						<input type="checkbox" name="skills" value="Testing"> Testing
					</label>
				</div>
				
				<h3 style="margin:16px 0 8px 0;">Experience Level</h3>
				<select id="experienceInput" style="width:100%; padding:10px; background:#1a1a1a; border:1px solid #333; border-radius:6px; color:#fff;">
					<option value="Beginner">Beginner</option>
					<option value="Intermediate">Intermediate</option>
					<option value="Advanced">Advanced</option>
					<option value="Expert">Expert</option>
				</select>
				
				<h3 style="margin:16px 0 8px 0;">Social Links (Optional)</h3>
				<input type="text" id="twitterInput" placeholder="X/Twitter handle (e.g., @username)" style="width:100%; padding:10px; background:#1a1a1a; border:1px solid #333; border-radius:6px; color:#fff; margin-bottom:8px;">
				<input type="text" id="githubInput" placeholder="GitHub username" style="width:100%; padding:10px; background:#1a1a1a; border:1px solid #333; border-radius:6px; color:#fff; margin-bottom:8px;">
				<input type="text" id="linkedinInput" placeholder="LinkedIn profile URL" style="width:100%; padding:10px; background:#1a1a1a; border:1px solid #333; border-radius:6px; color:#fff; margin-bottom:8px;">
				
				<h3 style="margin:16px 0 8px 0;">Privacy Settings</h3>
				<div style="display:flex; gap:16px; margin:8px 0;">
					<label style="display:flex; align-items:center; gap:6px;">
						<input type="radio" name="privacy" value="public" checked> Public
					</label>
					<label style="display:flex; align-items:center; gap:6px;">
						<input type="radio" name="privacy" value="private"> Private
					</label>
				</div>
			</div>
			
			<div style="display:flex; gap:12px; justify-content:flex-end;">
				<button class="btn secondary" onclick="closeCreateProfile()">Cancel</button>
				<button class="btn" onclick="saveProfile()">Save Profile</button>
			</div>
		</div>
	</div>

	<!-- Quest Content Modal -->
	<div id="questContentModal" class="modalBack">
		<div class="modal" style="max-width:800px;">
			<div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
				<h2 id="questContentTitle">Quest Content</h2>
				<a class="linkish" href="#" id="closeQuestContent">Close ‚úï</a>
			</div>
			<div id="questContentBody"></div>
			<div style="margin-top:20px; display:flex; gap:12px; justify-content:space-between;">
				<button class="btn secondary" id="prevStep">‚Üê Previous</button>
				<div style="flex:1; text-align:center;">
					<span id="stepIndicator">Step 1 of 3</span>
				</div>
				<button class="btn" id="nextStep">Next ‚Üí</button>
			</div>
		</div>
	</div>

	<!-- Mentorship Modal -->
	<div id="mentorshipModal" class="modalBack">
		<div class="modal" style="max-width:600px;">
			<div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
				<h2>üë• Available Mentors</h2>
				<a class="linkish" href="#" id="closeMentorship">Close ‚úï</a>
			</div>
			<div id="mentorList"></div>
		</div>
	</div>

	<!-- Pair Programming Modal -->
	<div id="pairProgrammingModal" class="modalBack">
		<div class="modal" style="max-width:500px;">
			<div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
				<h2>ü§ù Pair Programming Sessions</h2>
				<a class="linkish" href="#" id="closePairProgramming">Close ‚úï</a>
			</div>
			<div id="pairSessionList">
				<div style="padding:12px; border:1px solid #333; border-radius:8px; margin:8px 0; cursor:pointer;" onclick="joinPairSession(1)">
					<strong>Quest 1: Basic Move Syntax</strong><br>
					<small>2 developers waiting ‚Ä¢ Starting in 15 min</small>
				</div>
				<div style="padding:12px; border:1px solid #333; border-radius:8px; margin:8px 0; cursor:pointer;" onclick="joinPairSession(2)">
					<strong>Quest 3: Resource Model</strong><br>
					<small>1 developer waiting ‚Ä¢ Starting in 45 min</small>
				</div>
				<div style="padding:12px; border:1px solid #333; border-radius:8px; margin:8px 0; cursor:pointer;" onclick="joinPairSession(3)">
					<strong>Custom DeFi Project</strong><br>
					<small>3 developers online ‚Ä¢ Starting now</small>
				</div>
			</div>
		</div>
	</div>

	<!-- Personal Dashboard Modal -->
	<div id="personalDashboardModal" class="modalBack">
		<div class="modal" style="max-width:700px;">
			<div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
				<h2 id="dashboardTitle">üìä My Learning Dashboard</h2>
				<a class="linkish" href="#" id="closeDashboard">Close ‚úï</a>
			</div>
			<div id="dashboardContent">
				<div style="display:grid; gap:16px; grid-template-columns: repeat(auto-fit, minmax(150px,1fr)); margin:16px 0;">
					<div style="text-align:center; padding:12px; border:1px solid #333; border-radius:8px; background:#0f1f0f;">
						<div style="font-size:24px; font-weight:700; color:#82ffa1;" id="userQuestsCompleted">0</div>
						<div style="font-size:12px; color:#cfcfcf;">Quests Completed</div>
					</div>
					<div style="text-align:center; padding:12px; border:1px solid #333; border-radius:8px; background:#0f1f0f;">
						<div style="font-size:24px; font-weight:700; color:#82ffa1;" id="userStreak">0</div>
						<div style="font-size:12px; color:#cfcfcf;">Day Streak</div>
					</div>
					<div style="text-align:center; padding:12px; border:1px solid #333; border-radius:8px; background:#0f1f0f;">
						<div style="font-size:24px; font-weight:700; color:#82ffa1;" id="userLevel">1</div>
						<div style="font-size:12px; color:#cfcfcf;">Level</div>
					</div>
					<div style="text-align:center; padding:12px; border:1px solid #333; border-radius:8px; background:#0f1f0f;">
						<div style="font-size:24px; font-weight:700; color:#82ffa1;" id="userXP">0</div>
						<div style="font-size:12px; color:#cfcfcf;">XP Points</div>
					</div>
				</div>
				
				<h3>üèÜ Your Badges</h3>
				<div id="userBadges" class="chips"></div>
				
				<h3 style="margin-top:20px;">üìà Recommended Next Steps</h3>
				<div id="recommendations">
					<div style="padding:12px; border:1px solid #2a5a2a; border-radius:8px; background:#0f1f0f; margin:8px 0;">
						<strong>üéØ Complete Quest 1</strong><br>
						<small>Start with Move basics to build your foundation</small>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Move Code Editor Modal -->
	<div id="codeEditorModal" class="modalBack">
		<div class="modal" style="max-width:900px; max-height:90vh;">
			<div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
				<h2>‚ö° Move Code Editor</h2>
				<a class="linkish" href="#" id="closeCodeEditor">Close ‚úï</a>
			</div>
			<div style="margin:16px 0;">
				<div style="display:flex; gap:8px; margin-bottom:12px;">
					<button class="btn secondary" onclick="loadTemplate('basic')" style="font-size:12px;">Basic Template</button>
					<button class="btn secondary" onclick="loadTemplate('coin')" style="font-size:12px;">Coin Template</button>
					<button class="btn secondary" onclick="loadTemplate('defi')" style="font-size:12px;">DeFi Template</button>
					<button class="btn" onclick="runMoveCode()" style="font-size:12px;">üöÄ Run Code</button>
				</div>
				<textarea id="moveCodeEditor" style="width:100%; height:300px; background:#1a1a1a; color:#fff; border:1px solid #333; border-radius:8px; padding:12px; font-family:monospace; font-size:13px;" placeholder="// Write your Move code here...
module 0x1::hello_world {
    public fun hello(): vector<u8> {
        b&quot;Hello, Move!&quot;
    }
}"></textarea>
				<div id="codeOutput" style="background:#0f0f0f; border:1px solid #333; border-radius:8px; padding:12px; margin-top:8px; min-height:60px; font-family:monospace; font-size:12px;">
					<div style="color:#82ffa1;">üìù Code output will appear here...</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Hackathon Modal -->
	<div id="hackathonModal" class="modalBack">
		<div class="modal" style="max-width:600px;">
			<div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
				<h2>üèÜ Upcoming Mini-Hackathons</h2>
				<a class="linkish" href="#" id="closeHackathon">Close ‚úï</a>
			</div>
			<div style="margin:16px 0;">
				<div style="padding:16px; border:1px solid #333; border-radius:8px; margin:12px 0; cursor:pointer; transition:all 0.2s ease;" onclick="registerHackathon('defi')" onmouseover="this.style.borderColor='#82ffa1'" onmouseout="this.style.borderColor='#333'">
					<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
						<strong style="color:#82ffa1;">Move DeFi Challenge</strong>
						<span class="chip">Prize: 50 APT</span>
					</div>
					<p style="margin:0 0 8px 0; color:#cfcfcf;">Build innovative DeFi protocols using Move language</p>
					<div style="display:flex; gap:8px;">
						<span class="chip">Jan 15-17, 2025</span>
						<span class="chip">3 days</span>
						<span class="chip">Remote</span>
					</div>
					<div style="margin-top:8px; font-size:12px; color:#82ffa1;">
						üëÜ Click to register
					</div>
				</div>
				
				<div style="padding:16px; border:1px solid #333; border-radius:8px; margin:12px 0; cursor:pointer; transition:all 0.2s ease;" onclick="registerHackathon('nft')" onmouseover="this.style.borderColor='#82ffa1'" onmouseout="this.style.borderColor='#333'">
					<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
						<strong style="color:#82ffa1;">NFT Innovation Sprint</strong>
						<span class="chip">Prize: 30 APT</span>
					</div>
					<p style="margin:0 0 8px 0; color:#cfcfcf;">Create unique NFT projects and marketplaces</p>
					<div style="display:flex; gap:8px;">
						<span class="chip">Jan 22-24, 2025</span>
						<span class="chip">3 days</span>
						<span class="chip">Hybrid</span>
					</div>
					<div style="margin-top:8px; font-size:12px; color:#82ffa1;">
						üëÜ Click to register
					</div>
				</div>
			</div>
		</div>
	</div>

	<script>
	// Global scope - no IIFE
	// Quests catalog
	window.quests = [
		{ id:1, title:'üéØ Basic Move Syntax', diff:'Beginner', reward:'10 APT', desc:'Move basics: variables, functions, types.' },
		{ id:2, title:'üîß Struct & Functions', diff:'Intermediate', reward:'20 APT', desc:'Structs, public functions, and modular design.' },
		{ id:3, title:'üí∞ Resource Model', diff:'Advanced', reward:'40 APT', desc:'Resource safety, abilities, and ownership model.' },
		{ id:4, title:'üîÑ Control Flow', diff:'Beginner', reward:'12 APT', desc:'Conditionals, loops, and patterns.' },
		{ id:5, title:'üì¶ Modules', diff:'Intermediate', reward:'25 APT', desc:'Module design, visibility, dependencies.' },
		{ id:6, title:'üõ°Ô∏è Security', diff:'Advanced', reward:'50 APT', desc:'Security best practices, testing, and reviews.' }
	];

	// Builder profiles (updated names)
	window.profiles = [
			{ id:1, name:'Ne≈üe Demir', handle:'@nese', bio:'Focused on Move security & smart contract auditing.', skills:['Move','Security','Auditing','Testing'], tz:'GMT+3', avail:'Mentor: Available', completed: 35, streak: 16, badges:['Security Expert','Auditor','Top Contributor'], links:[{t:'GitHub',u:'https://github.com/'},{t:'X',u:'https://x.com/'}] },
			{ id:2, name:'Deniz Arda', handle:'@deniz', bio:'Tooling and developer experience.', skills:['Move','Tooling','DX','CLI'], tz:'GMT+1', avail:'Mentor: Busy', completed: 20, streak: 5, badges:['DX Builder','CLI Wizard'], links:[{t:'GitHub',u:'https://github.com/'},{t:'Site',u:'#'}] },
			{ id:3, name:'Efe Can', handle:'@efecan', bio:'Quests and education content.', skills:['Move','Education','Docs'], tz:'GMT+2', avail:'Mentor: Available', completed: 18, streak: 9, badges:['Educator','Quest Maker'], links:[{t:'GitHub',u:'https://github.com/'}] },
			{ id:4, name:'Dilek √ñzkan', handle:'@dilek', bio:'DeFi protocols and yield farming specialist.', skills:['DeFi','Protocols','Yield','Finance'], tz:'GMT+3', avail:'Mentor: Available', completed: 29, streak: 18, badges:['DeFi Master','Protocol Builder'], links:[{t:'GitHub',u:'https://github.com/'},{t:'LinkedIn',u:'https://linkedin.com/'}] },
			{ id:5, name:'Okan T.', handle:'@okant', bio:'Collaboration & hackathon facilitator.', skills:['Collab','Hackathons','PM'], tz:'GMT+3', avail:'Mentor: Busy', completed: 14, streak: 3, badges:['Facilitator'], links:[{t:'GitHub',u:'https://github.com/'}] },
			{ id:6, name:'Selin A.', handle:'@selina', bio:'Analytics and platform metrics.', skills:['Analytics','Metrics','Dashboards'], tz:'GMT-1', avail:'Mentor: Available', completed: 22, streak: 12, badges:['Insights Pro'], links:[{t:'GitHub',u:'https://github.com/'}] }
		];

		// Elements
		const exploreBtn = document.getElementById('exploreQuests');
		const modal = document.getElementById('questsModal');
		const closeModal = document.getElementById('closeModal');
		const grid = document.getElementById('qgrid');

		const profilesGrid = document.getElementById('profilesGrid');
		const pModal = document.getElementById('profileModal');
		const pmClose = document.getElementById('pm_close');
		const pmName = document.getElementById('pm_name');
		const pmBio = document.getElementById('pm_bio');
		const pmSkills = document.getElementById('pm_skills');
		const pmAvail = document.getElementById('pm_avail');
		const pmTz = document.getElementById('pm_tz');
		const pmLinks = document.getElementById('pm_links');
		const pmCompleted = document.getElementById('pm_completed');
		const pmStreak = document.getElementById('pm_streak');
		const pmBadges = document.getElementById('pm_badges');

		// Render profiles (3-3 grid), include quick summary
		profilesGrid.innerHTML = profiles.map(p => {
			// Handle avatar display - with safety checks
			let avatarHtml = '';
			
			// Check if avatar exists and is not corrupted
			if (p.avatar && typeof p.avatar === 'string' && p.avatar.length < 1000) {
				if (p.avatar.startsWith('data:image/')) {
					// Custom uploaded image
					avatarHtml = `<img src="${p.avatar}" style="width:50px; height:50px; border-radius:50%; object-fit:cover; border:2px solid #82ffa1; margin-bottom:10px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">`;
				} else if (p.avatar.length <= 2) {
					// Emoji avatar (single character)
					avatarHtml = `<div style="width:50px; height:50px; border-radius:50%; background:#333; border:2px solid #82ffa1; display:flex; align-items:center; justify-content:center; font-size:24px; margin:0 auto 10px auto;">${p.avatar}</div>`;
				} else {
					// Fallback for other cases
					avatarHtml = `<div style="width:50px; height:50px; border-radius:50%; background:#333; border:2px solid #82ffa1; display:flex; align-items:center; justify-content:center; font-size:20px; margin:0 auto 10px auto; color:#82ffa1;">${p.name.charAt(0)}</div>`;
				}
			} else {
				// Default placeholder
				avatarHtml = `<div style="width:50px; height:50px; border-radius:50%; background:#333; border:2px solid #82ffa1; display:flex; align-items:center; justify-content:center; font-size:20px; margin:0 auto 10px auto; color:#82ffa1;">${p.name.charAt(0)}</div>`;
			}
			
			return `
			<div class="card">
				<div style="text-align:center;">
					${avatarHtml}
					<h3>${p.name} <span style="color:#bdbdbd; font-weight:400">${p.handle}</span></h3>
				</div>
				<p>${p.bio}</p>
				<div class="chips">
					${p.skills.map(s => `<span class=\"chip\">${s}</span>`).join('')}
				</div>
				<div class="row" style="margin-top:10px; justify-content:space-between;">
					<span class="badge">Completed: ${p.completed}</span>
					<span class="badge">Streak: ${p.streak}d</span>
				</div>
				<div class="row" style="margin-top:12px; gap:6px;">
					<button class="btn" data-profile="${p.id}" style="flex:1; font-size:12px;">View Profile</button>
					<button class="btn secondary" data-action="follow" data-handle="${p.handle}" id="followBtn_${p.handle}" style="flex:1; font-size:12px;">Follow</button>
					<button class="btn secondary" data-action="message" data-handle="${p.handle}" data-name="${p.name}" style="flex:1; font-size:12px;">üí¨ Message</button>
				</div>
			</div>
		`}).join('');

		profilesGrid.addEventListener('click', (e) => {
			const t = e.target;
			if (t && t instanceof Element && t.getAttribute('data-profile')) {
				const id = Number(t.getAttribute('data-profile'));
				const p = profiles.find(x => x.id === id);
				if (!p) return;
				
				// Set profile data
				pmName.textContent = p.name + ' ' + p.handle;
				pmBio.textContent = p.bio;
				pmSkills.innerHTML = p.skills.map(s => `<span class=\"chip\">${s}</span>`).join('');
				pmAvail.textContent = p.avail;
				pmTz.textContent = p.tz;
				pmLinks.innerHTML = p.links.map(l => `<a class=\"linkish\" href=\"${l.u}\" target=\"_blank\">${l.t}</a>`).join(' ¬∑ ');
				pmCompleted.textContent = String(p.completed);
				pmStreak.textContent = String(p.streak);
				pmBadges.innerHTML = (p.badges || []).map(b => `<span class=\"chip\">${b}</span>`).join('');
				
				// Set avatar in profile modal
				const avatarDiv = document.getElementById('pm_avatar');
				if (avatarDiv) {
					// Hide upload button for other users
					const uploadSection = document.getElementById('avatarUploadSection');
					if (uploadSection) {
						uploadSection.style.display = 'none';
					}
					
					// Clear existing avatar content
					avatarDiv.innerHTML = '';
					
					// Add avatar image
					const avatarImg = document.createElement('img');
					avatarImg.id = 'profileAvatarImg';
					
					if (p.avatar && p.avatar.startsWith('data:image/')) {
						// Custom uploaded image
						avatarImg.src = p.avatar;
					} else if (p.avatar) {
						// Emoji avatar - use placeholder
						avatarImg.src = 'https://via.placeholder.com/80x80/333/fff?text=' + encodeURIComponent(p.avatar);
					} else {
						// Default placeholder
						avatarImg.src = 'https://via.placeholder.com/80x80/333/fff?text=' + p.name.charAt(0);
					}
					
					// Set image styles
					avatarImg.style.width = '80px';
					avatarImg.style.height = '80px';
					avatarImg.style.borderRadius = '50%';
					avatarImg.style.border = '2px solid #82ffa1';
					avatarImg.style.objectFit = 'cover';
					avatarImg.style.display = 'block';
					avatarImg.style.margin = '10px auto';
					avatarImg.style.backgroundColor = '#333';
					
					avatarDiv.appendChild(avatarImg);
				}
				
				pModal.style.display = 'grid';
			}
			
			// Handle follow button
			if (t && t instanceof Element && t.getAttribute('data-action') === 'follow') {
				const handle = t.getAttribute('data-handle');
				toggleFollow(handle);
			}
			
			// Handle message button
			if (t && t instanceof Element && t.getAttribute('data-action') === 'message') {
				const handle = t.getAttribute('data-handle');
				const name = t.getAttribute('data-name');
				openChat(handle, name);
			}
		});

		pmClose.addEventListener('click', (e) => { e.preventDefault(); pModal.style.display='none'; });
		pModal.addEventListener('click', (e) => { if (e.target === pModal) pModal.style.display='none'; });

		// Enhanced quests modal
		exploreBtn.addEventListener('click', () => {
			grid.innerHTML = quests.map(q => `
				<div class=\"qcard\">
					<div class=\"qtop\">
						<h3 style=\"margin:0; font-size:16px\">${q.title}</h3>
						<span class=\"qdiff\">${q.diff}</span>
					</div>
					<p class=\"qdesc\">${q.desc}</p>
					<div class=\"qrow\">
						<span class=\"qreward\">Reward: ${q.reward}</span>
						<button class=\"btn\" onclick=\"startQuest(${q.id})\">${walletConnected ? 'Start Quest' : 'Connect Wallet'}</button>
					</div>
					<div style=\"display:flex; gap:8px; margin-top:8px; justify-content:center;\">
						<button onclick=\"likeQuest(${q.id}, '‚ù§Ô∏è')\" style=\"background:transparent; border:1px solid #333; color:#fff; padding:4px 8px; border-radius:4px; cursor:pointer;\">‚ù§Ô∏è <span id=\"likes-${q.id}\">0</span></button>
						<button onclick=\"likeQuest(${q.id}, 'üî•')\" style=\"background:transparent; border:1px solid #333; color:#fff; padding:4px 8px; border-radius:4px; cursor:pointer;\">üî• <span id=\"fire-${q.id}\">0</span></button>
						<button onclick=\"likeQuest(${q.id}, 'üöÄ')\" style=\"background:transparent; border:1px solid #333; color:#fff; padding:4px 8px; border-radius:4px; cursor:pointer;\">üöÄ <span id=\"rocket-${q.id}\">0</span></button>
					</div>
				</div>
			`).join('');
			modal.style.display = 'grid';
		});

		// Quest content modal elements
		const questContentModal = document.getElementById('questContentModal');
		const questContentTitle = document.getElementById('questContentTitle');
		const questContentBody = document.getElementById('questContentBody');
		const stepIndicator = document.getElementById('stepIndicator');
		const prevStepBtn = document.getElementById('prevStep');
		const nextStepBtn = document.getElementById('nextStep');
		const closeQuestContent = document.getElementById('closeQuestContent');

		// Start quest function
		window.startQuest = function(questId) {
			if (!walletConnected) {
				alert('Please connect your wallet first!');
				return;
			}

			const questContent = questContents[questId];
			if (questContent) {
				currentQuestId = questId;
				currentStep = 0;
				showQuestContent();
				modal.style.display = 'none';
			} else {
				alert('Quest content coming soon!');
			}
		};

		function showQuestContent() {
			const questContent = questContents[currentQuestId];
			if (!questContent) return;

			questContentTitle.textContent = questContent.title;
			questContentBody.innerHTML = questContent.steps[currentStep].content;
			stepIndicator.textContent = `Step ${currentStep + 1} of ${questContent.steps.length}`;
			
			prevStepBtn.style.display = currentStep > 0 ? 'block' : 'none';
			nextStepBtn.textContent = currentStep === questContent.steps.length - 1 ? 'Complete Quest' : 'Next ‚Üí';
			
			questContentModal.style.display = 'grid';
		}

		// Quest navigation
		prevStepBtn.addEventListener('click', () => {
			if (currentStep > 0) {
				currentStep--;
				showQuestContent();
			}
		});

		nextStepBtn.addEventListener('click', () => {
			const questContent = questContents[currentQuestId];
			if (currentStep < questContent.steps.length - 1) {
				currentStep++;
				showQuestContent();
			} else {
				questContentModal.style.display = 'none';
				const quest = quests.find(q => q.id === currentQuestId);
				completeQuestWithSharing(currentQuestId, quest.title);
			}
		});

		closeQuestContent.addEventListener('click', (e) => {
			e.preventDefault();
			questContentModal.style.display = 'none';
		});

		questContentModal.addEventListener('click', (e) => {
			if (e.target === questContentModal) {
				questContentModal.style.display = 'none';
			}
		});

		closeModal.addEventListener('click', (e) => { e.preventDefault(); modal.style.display='none'; });
		modal.addEventListener('click', (e) => { if (e.target === modal) modal.style.display='none'; });

		document.getElementById('viewStats').addEventListener('click', () => {
			// Show quest progress with on-chain verification
			showQuestProgress();
		});

		// Enhanced functionality
	window.walletConnected = false;
	window.walletAddress = null;
	window.userProfile = null;
	window.selectedAvatar = 'üßë‚Äçüíª';
	window.currentQuestId = null;
	window.currentStep = 0;
	window.notificationPermission = false;
	
	// Load wallet state from localStorage on page load
	window.addEventListener('load', function() {
		const savedWalletState = localStorage.getItem('walletState');
		if (savedWalletState) {
			const walletState = JSON.parse(savedWalletState);
			window.walletConnected = walletState.connected;
			window.walletAddress = walletState.address;
		}
		
		// Load user profile
		const savedProfile = localStorage.getItem('userProfile');
		if (savedProfile) {
			window.userProfile = JSON.parse(savedProfile);
			console.log('‚úÖ Profile loaded:', window.userProfile);
			
			// Check for corrupted avatar data - more aggressive cleaning
			if (window.userProfile.avatar) {
				if (window.userProfile.avatar.length > 100 || 
					(typeof window.userProfile.avatar === 'string' && window.userProfile.avatar.includes('base64'))) {
					console.log('‚ö†Ô∏è Corrupted avatar data detected, clearing...');
					console.log('üîç Avatar preview:', window.userProfile.avatar.substring(0, 100));
					window.userProfile.avatar = null;
					localStorage.setItem('userProfile', JSON.stringify(window.userProfile));
					console.log('‚úÖ Corrupted avatar data cleared');
				}
			}
		} else {
			console.log('‚ùå No profile found in localStorage');
		}
		
		// Update UI after both wallet and profile are loaded
		if (window.walletConnected && window.walletAddress) {
			updateWalletUI();
		}
		
		// Restore follow button states
		setTimeout(() => {
			if (window.userProfile && window.userProfile.following) {
				window.userProfile.following.forEach(handle => {
					const followBtn = document.getElementById(`followBtn_${handle}`);
					if (followBtn) {
						followBtn.textContent = 'Followed';
						followBtn.classList.remove('btn', 'secondary');
						followBtn.classList.add('btn');
					}
				});
			}
		}, 500); // Reduced timeout
		
		// Also restore when profiles are rendered
		const originalRenderProfiles = window.renderProfiles;
		if (originalRenderProfiles) {
			window.renderProfiles = function() {
				originalRenderProfiles();
				// Restore follow states after rendering
				setTimeout(() => {
					if (window.userProfile && window.userProfile.following) {
						window.userProfile.following.forEach(handle => {
							const followBtn = document.getElementById(`followBtn_${handle}`);
							if (followBtn) {
								followBtn.textContent = 'Followed';
								followBtn.classList.remove('btn', 'secondary');
								followBtn.classList.add('btn');
							}
						});
					}
				}, 100);
			};
		}
	});

		// Quest content data
		const questContents = {
			1: {
				title: 'üéØ Basic Move Syntax',
				steps: [
					{
						title: 'Challenge 1: Variable Declaration',
						content: `<h3>üéØ Your Mission</h3><p>Complete this Move function:</p><div style="background:#2a2a2a; padding:12px; border-radius:8px; margin:8px 0;"><pre><code>fun init_user(): (u64, address, bool) {
    let balance: u64 = <span style="background:#4a1a1a; color:#ff6b6b; padding:2px 4px;">_____</span>;  // Set to 1000
    let addr: address = <span style="background:#4a1a1a; color:#ff6b6b; padding:2px 4px;">_____</span>;  // Set to @0x1
    let active: bool = <span style="background:#4a1a1a; color:#ff6b6b; padding:2px 4px;">_____</span>;   // Set to true
    (balance, addr, active)
}</code></pre></div><p><strong>Fill in:</strong> 1000, @0x1, true</p>`
					},
					{
						title: 'Challenge 2: Functions',
						content: `<h3>üéØ Complete the Calculator</h3><div style="background:#2a2a2a; padding:12px; border-radius:8px;"><pre><code>public fun add(a: u64, b: u64): u64 {
    <span style="background:#4a1a1a; color:#ff6b6b; padding:2px 4px;">_____</span>  // Return a + b
}

public fun multiply(x: u64, y: u64): u64 {
    <span style="background:#4a1a1a; color:#ff6b6b; padding:2px 4px;">_____</span>  // Return x * y
}</code></pre></div><p><strong>Answers:</strong> a + b, x * y</p>`
					},
					{
						title: 'Quest Complete!',
						content: `<div style="background:#1a4a2e; padding:16px; border-radius:8px; text-align:center;"><h3>üéâ Quest Completed!</h3><p>You've mastered Move basics!</p><p><strong>Reward:</strong> 0.1 APT + "Move Beginner" badge</p></div>`
					}
				]
			},
			2: {
				title: 'üîß Struct & Functions',
				steps: [
					{
						title: 'Challenge: Build User Profile',
						content: `<h3>üéØ Create a User Struct</h3><div style="background:#2a2a2a; padding:12px; border-radius:8px;"><pre><code>struct User has copy, drop {
    name: vector&lt;u8&gt;,
    level: <span style="background:#4a1a1a; color:#ff6b6b; padding:2px 4px;">_____</span>,     // u8 type
    balance: <span style="background:#4a1a1a; color:#ff6b6b; padding:2px 4px;">_____</span>,  // u64 type
}</code></pre></div><p><strong>Fill in:</strong> u8, u64</p>`
					},
					{
						title: 'Quest Complete!',
						content: `<div style="background:#1a4a2e; padding:16px; border-radius:8px; text-align:center;"><h3>üéâ Struct Master!</h3><p>You understand Move structs!</p><p><strong>Reward:</strong> 0.2 APT + "Struct Expert" badge</p></div>`
					}
				]
			},
			3: {
				title: 'üí∞ Resource Model',
				steps: [
					{
						title: 'Challenge: Secure Coin',
						content: `<h3>üéØ Create Secure Resource</h3><div style="background:#2a2a2a; padding:12px; border-radius:8px;"><pre><code>struct Coin has <span style="background:#4a1a1a; color:#ff6b6b; padding:2px 4px;">_____</span> {  // Only "store" - no copy/drop
    value: u64,
}</code></pre></div><p><strong>Answer:</strong> store (Resources can't be copied or dropped for security!)</p>`
					},
					{
						title: 'Quest Complete!',
						content: `<div style="background:#1a4a2e; padding:16px; border-radius:8px; text-align:center;"><h3>üéâ Security Expert!</h3><p>You understand Move resources!</p><p><strong>Reward:</strong> 0.4 APT + "Security Pro" badge</p></div>`
					}
				]
			},
			4: {
				title: 'üîÑ Control Flow',
				steps: [
					{
						title: 'Challenge: Access Control',
						content: `<h3>üéØ Build Access Control</h3><div style="background:#2a2a2a; padding:12px; border-radius:8px;"><pre><code>public fun check_access(level: u8, premium: bool): bool {
    if (level >= <span style="background:#4a1a1a; color:#ff6b6b; padding:2px 4px;">_____</span>) {  // VIP level 10+
        return true
    };
    if (premium) {
        return true
    };
    false
}</code></pre></div><p><strong>Fill in:</strong> 10</p>`
					},
					{
						title: 'Quest Complete!',
						content: `<div style="background:#1a4a2e; padding:16px; border-radius:8px; text-align:center;"><h3>üéâ Logic Master!</h3><p>Control flow mastered!</p><p><strong>Reward:</strong> 0.12 APT + "Logic Expert" badge</p></div>`
					}
				]
			},
			5: {
				title: 'üì¶ Modules',
				steps: [
					{
						title: 'Challenge: Module Design',
						content: `<h3>üéØ Create DeFi Module</h3><div style="background:#2a2a2a; padding:12px; border-radius:8px;"><pre><code>module 0x1::defi_core {
    use std::signer;
    
    struct Pool has <span style="background:#4a1a1a; color:#ff6b6b; padding:2px 4px;">_____</span> {  // "key" for global storage
        token_a: u64,
        token_b: u64,
    }
}</code></pre></div><p><strong>Answer:</strong> key</p>`
					},
					{
						title: 'Quest Complete!',
						content: `<div style="background:#1a4a2e; padding:16px; border-radius:8px; text-align:center;"><h3>üéâ Module Architect!</h3><p>Module design mastered!</p><p><strong>Reward:</strong> 0.25 APT + "Architect" badge</p></div>`
					}
				]
			},
			6: {
				title: 'üõ°Ô∏è Security',
				steps: [
					{
						title: 'Challenge: Security Patterns',
						content: `<h3>üéØ Secure Withdrawal</h3><div style="background:#2a2a2a; padding:12px; border-radius:8px;"><pre><code>public entry fun withdraw(account: &signer, amount: u64) {
    // Security check
    assert!(amount <= <span style="background:#4a1a1a; color:#ff6b6b; padding:2px 4px;">_____</span>, E_INSUFFICIENT_FUNDS);  // user.balance
    
    user.balance = user.balance - amount;
}</code></pre></div><p><strong>Answer:</strong> user.balance</p>`
					},
					{
						title: 'Quest Complete!',
						content: `<div style="background:#1a4a2e; padding:16px; border-radius:8px; text-align:center;"><h3>üéâ Security Auditor!</h3><p>Security expert achieved!</p><p><strong>Reward:</strong> 0.5 APT + "Security Pro" badge</p></div>`
					}
				]
			}
		};

		// Mobile detection
		function isMobile() {
			return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
		}

		async function connectWallet() {
			console.log('üîó Connect wallet clicked');
			
			// First check if Petra is available
			console.log('üîç window.aptos:', window.aptos);
			
			try {
				if (!window.aptos) {
					alert('‚ùå Petra wallet not detected!\n\nPlease:\n1. Install Petra extension\n2. Refresh the page\n3. Try again');
					window.open('https://petra.app/', '_blank');
					return;
				}
				
				console.log('üì± Petra detected, calling connect...');
				alert('üì± Petra detected! Click OK, then approve in wallet popup.');
				
				const response = await window.aptos.connect();
				console.log('‚úÖ Wallet response:', response);
				
				window.walletAddress = response.address;
				window.walletConnected = true;
				
				// Save wallet state to localStorage
				localStorage.setItem('walletState', JSON.stringify({
					connected: true,
					address: response.address
				}));
				
				updateWalletUI();
				
				// Check if profile exists
				const savedProfile = localStorage.getItem(`profile_${window.walletAddress}`);
				if (savedProfile) {
					window.userProfile = JSON.parse(savedProfile);
					alert('‚úÖ Welcome back, ' + window.userProfile.username + '!');
				} else {
					alert('‚úÖ Wallet connected! Create your profile to get started.');
					setTimeout(() => {
						document.getElementById('createProfileModal').style.display = 'grid';
					}, 1000);
				}
			} catch (error) {
				console.error('‚ùå Wallet error:', error);
				alert('‚ùå Error: ' + error.message);
			}
		}

		async function disconnectWallet() {
			try {
				if (window.aptos) await window.aptos.disconnect();
				walletConnected = false;
				walletAddress = null;
				updateWalletUI();
				alert('Wallet disconnected');
			} catch (error) {
				console.error('Disconnect failed');
			}
		}

		function updateWalletUI() {
			const connectBtn = document.getElementById('connectWallet');
			const walletInfo = document.getElementById('walletInfo');
			const addressDiv = document.getElementById('walletAddress');
			const userNameDiv = document.getElementById('userName');

			console.log('üîç updateWalletUI called');
			console.log('walletConnected:', walletConnected);
			console.log('walletAddress:', walletAddress);
			console.log('userProfile:', userProfile);

			if (walletConnected && walletAddress) {
				connectBtn.style.display = 'none';
				walletInfo.style.display = 'block';
				addressDiv.textContent = walletAddress.slice(0, 6) + '...' + walletAddress.slice(-4);
				
				// Show user name if profile exists
				const savedProfile = localStorage.getItem('userProfile');
				if (savedProfile) {
					const profile = JSON.parse(savedProfile);
					if (profile.name || profile.username) {
						userNameDiv.textContent = profile.name || profile.username;
						userNameDiv.style.display = 'block';
						console.log('‚úÖ User name set:', profile.name || profile.username);
					} else {
						userNameDiv.style.display = 'none';
						console.log('‚ùå No user name in profile');
					}
				} else {
					userNameDiv.style.display = 'none';
					console.log('‚ùå No profile found');
				}
			} else {
				connectBtn.style.display = 'block';
				walletInfo.style.display = 'none';
			}
		}

		// Referral system
		function checkReferral() {
			const urlParams = new URLSearchParams(window.location.search);
			const referralCode = urlParams.get('ref');
			
			if (referralCode && !localStorage.getItem('referral_used')) {
				localStorage.setItem('referral_code', referralCode);
				alert('üéÅ Referral bonus! You\'ll get +10% rewards!');
			}
		}

		// Referral link generation
		document.getElementById('getReferralLink').addEventListener('click', () => {
			if (!walletConnected) {
				alert('Please connect wallet first!');
				return;
			}
			
			const referralCode = walletAddress.slice(-8);
			const referralLink = `https://movebuildershub.xyz?ref=${referralCode}`;
			
			navigator.clipboard.writeText(referralLink).then(() => {
				alert(`üîó Referral link copied!\n\n${referralLink}\n\nFriends get +10% rewards!`);
			});
		});
		
		
		// Toggle user dropdown
		window.toggleUserDropdown = function() {
			const dropdown = document.getElementById('userProfileDropdown');
			if (dropdown.style.display === 'none' || dropdown.style.display === '') {
				dropdown.style.display = 'block';
			} else {
				dropdown.style.display = 'none';
			}
		};
		
		// Close dropdown when clicking outside
		document.addEventListener('click', (e) => {
			const dropdown = document.getElementById('userProfileDropdown');
			const walletInfo = document.getElementById('walletInfo');
			if (dropdown && !walletInfo.contains(e.target)) {
				dropdown.style.display = 'none';
			}
		});
		
		// View My Profile functionality
		document.getElementById('viewMyProfileBtn').addEventListener('click', () => {
			console.log('üîç View My Profile button clicked');
			
			// Close dropdown first
			document.getElementById('userProfileDropdown').style.display = 'none';
			
			// Call showMyProfile function
			console.log('üîç Calling showMyProfile function');
			showMyProfile();
			
			// Close dropdown
			document.getElementById('userProfileDropdown').style.display = 'none';
			
			// Open user's own profile directly
			showMyProfile();
		});
		
		// Edit Profile functionality
		document.getElementById('editProfileBtn').addEventListener('click', () => {
			// Close dropdown
			document.getElementById('userProfileDropdown').style.display = 'none';
			
			// Open profile creation modal for editing
			document.getElementById('createProfileModal').style.display = 'block';
		});
		
		// Get Referral Link functionality
		document.getElementById('getReferralLinkBtn').addEventListener('click', () => {
			if (!walletConnected) {
				alert('Please connect wallet first to get your referral link!');
				return;
			}
			
			const referralCode = walletAddress.slice(-8);
			const referralLink = `https://movebuildershub.xyz?ref=${referralCode}`;
			
			navigator.clipboard.writeText(referralLink).then(() => {
				alert(`üîó Your referral link copied!\n\n${referralLink}\n\nShare with friends to get +10% rewards!`);
			});
			
			// Close dropdown
			document.getElementById('userProfileDropdown').style.display = 'none';
		});
		
		// Social Links functionality
		document.getElementById('socialLinksBtn').addEventListener('click', () => {
			// Close dropdown
			document.getElementById('userProfileDropdown').style.display = 'none';
			
			// Open social links modal (we'll create this)
			alert('Social Links feature coming soon!');
		});
		
		// Close dropdown
		document.getElementById('closeDropdown').addEventListener('click', (e) => {
			e.preventDefault();
			e.stopPropagation();
			document.getElementById('userProfileDropdown').style.display = 'none';
		});
		
		// Close profile modal
		document.getElementById('pm_close').addEventListener('click', (e) => {
			e.preventDefault();
			document.getElementById('profileModal').style.display = 'none';
		});
		
		// Avatar upload functionality for profile modal
		document.addEventListener('change', function(e) {
			if (e.target && e.target.id === 'avatarUpload') {
				const file = e.target.files[0];
				if (file) {
					// Check file size (max 2MB)
					if (file.size > 2 * 1024 * 1024) {
						alert('File size too large! Please choose an image smaller than 2MB.');
						return;
					}
					
					// Check file type
					if (!file.type.startsWith('image/')) {
						alert('Please select an image file!');
						return;
					}
					
					// Convert to base64
					const reader = new FileReader();
					reader.onload = function(e) {
						const base64String = e.target.result;
						console.log('üîç Uploaded avatar base64 length:', base64String.length);
						console.log('üîç Uploaded avatar starts with:', base64String.substring(0, 50));
						
						// Update user profile in localStorage
						const savedProfile = localStorage.getItem('userProfile');
						if (savedProfile) {
							const userProfile = JSON.parse(savedProfile);
							userProfile.avatar = base64String;
							localStorage.setItem('userProfile', JSON.stringify(userProfile));
							console.log('‚úÖ Avatar saved to localStorage');
							
							// Update the displayed avatar immediately
							const avatarImg = document.getElementById('profileAvatarImg');
							if (avatarImg) {
								avatarImg.src = base64String;
								console.log('‚úÖ Avatar updated in profile modal');
							}
							
							alert('‚úÖ Avatar updated successfully!');
						}
					};
					reader.readAsDataURL(file);
				}
			}
		});
		
		// Custom avatar upload functionality (for profile creation/editing)
		document.getElementById('customAvatarUpload').addEventListener('change', function(e) {
			const file = e.target.files[0];
			if (file) {
				// Check file size (max 2MB)
				if (file.size > 2 * 1024 * 1024) {
					alert('File size too large! Please choose an image smaller than 2MB.');
					return;
				}
				
				// Check file type
				if (!file.type.startsWith('image/')) {
					alert('Please select an image file!');
					return;
				}
				
				// Convert to base64
				const reader = new FileReader();
				reader.onload = function(e) {
					// Store custom avatar
					window.customAvatar = e.target.result;
					
					// Show preview
					document.getElementById('customAvatarImg').src = e.target.result;
					document.getElementById('customAvatarPreview').style.display = 'block';
					
					// Clear emoji selection
					document.querySelectorAll('.avatar-option').forEach(option => {
						option.style.borderColor = '#333';
					});
					
					alert('‚úÖ Custom avatar selected!');
				};
				reader.readAsDataURL(file);
			}
		});
		
		// Show my profile function
		window.showMyProfile = function() {
			console.log('üîç showMyProfile function called');
			
			// Load profile from localStorage
			const savedProfile = localStorage.getItem('userProfile');
			if (!savedProfile) {
				console.log('‚ùå No profile found in localStorage');
				alert('Please create your profile first!');
				return;
			}
			
			console.log('‚úÖ Profile found in localStorage');
			
			const userProfile = JSON.parse(savedProfile);
			console.log('üîç showMyProfile - userProfile:', userProfile);
			console.log('üîç Avatar data type:', typeof userProfile.avatar);
			console.log('üîç Avatar data length:', userProfile.avatar ? userProfile.avatar.length : 'null');
			console.log('üîç Avatar starts with data:image:', userProfile.avatar ? userProfile.avatar.startsWith('data:image/') : 'null');
			
			// Fill profile modal with user's own data
			document.getElementById('pm_name').textContent = 'My Profile';
			
			// Safe username handling
			const username = userProfile.name || userProfile.username || 'Unknown User';
			document.getElementById('pm_username').textContent = username;
			
			// Safe handle handling
			const handle = userProfile.handle || userProfile.username || 'unknown';
			document.getElementById('pm_handle').textContent = '@' + handle.toLowerCase().replace(/\s+/g, '_');
			
			// Safe bio handling
			document.getElementById('pm_bio').textContent = userProfile.bio || 'No bio available';
			
			// Avatar - Clear and rebuild completely
			const avatarDiv = document.getElementById('pm_avatar');
			if (avatarDiv) {
				// Clear everything first
				avatarDiv.innerHTML = '';
				
				// Add upload button for own profile
				const uploadSection = document.createElement('div');
				uploadSection.id = 'avatarUploadSection';
				uploadSection.style.marginBottom = '15px';
				uploadSection.innerHTML = `
					<input type="file" id="avatarUpload" accept="image/*" style="display:none;">
					<button class="btn secondary" onclick="document.getElementById('avatarUpload').click()" style="font-size:11px;">üì∑ Upload Avatar</button>
				`;
				avatarDiv.appendChild(uploadSection);
				
				// Add avatar image
				const avatarImg = document.createElement('img');
				avatarImg.id = 'profileAvatarImg';
				
				// Debug avatar data
				if (userProfile.avatar) {
					console.log('üîç Avatar first 100 chars:', userProfile.avatar.substring(0, 100));
					
					// Check if avatar is base64 (custom image) or emoji
					if (userProfile.avatar.startsWith('data:image/')) {
						// Custom uploaded image - use base64 directly
						avatarImg.src = userProfile.avatar;
						console.log('‚úÖ Custom avatar loaded from base64');
					} else if (userProfile.avatar.length > 100 && userProfile.avatar.includes('base64')) {
						// Might be base64 without data:image/ prefix
						avatarImg.src = 'data:image/png;base64,' + userProfile.avatar;
						console.log('‚úÖ Base64 avatar loaded with prefix');
					} else {
						// Emoji avatar
						avatarImg.src = 'https://via.placeholder.com/80x80/333/fff?text=' + encodeURIComponent(userProfile.avatar);
						console.log('‚úÖ Emoji avatar loaded');
					}
				} else {
					// Default placeholder
					avatarImg.src = 'https://via.placeholder.com/80x80/333/fff?text=' + (userProfile.name?.charAt(0) || 'U');
					console.log('‚úÖ Default avatar loaded');
				}
				
				// Set image styles
				avatarImg.style.width = '80px';
				avatarImg.style.height = '80px';
				avatarImg.style.borderRadius = '50%';
				avatarImg.style.border = '2px solid #82ffa1';
				avatarImg.style.objectFit = 'cover';
				avatarImg.style.display = 'block';
				avatarImg.style.margin = '10px auto';
				avatarImg.style.backgroundColor = '#333';
				
				// Add error handling for image loading
				avatarImg.onerror = function() {
					console.log('‚ùå Avatar image failed to load, using placeholder');
					this.src = 'https://via.placeholder.com/80x80/333/fff?text=' + (userProfile.name?.charAt(0) || 'U');
				};
				
				avatarImg.onload = function() {
					console.log('‚úÖ Avatar image loaded successfully');
				};
				
				avatarDiv.appendChild(avatarImg);
			}
			
			// Skills
			const skillsDiv = document.getElementById('pm_skills');
			skillsDiv.innerHTML = '';
			if (userProfile.skills && userProfile.skills.length > 0) {
				userProfile.skills.forEach(skill => {
					const chip = document.createElement('span');
					chip.className = 'chip';
					chip.textContent = skill;
					skillsDiv.appendChild(chip);
				});
			} else {
				skillsDiv.innerHTML = '<span class="chip">No skills listed</span>';
			}
			
			// Availability and timezone
			document.getElementById('pm_avail').textContent = userProfile.availability || 'Available';
			document.getElementById('pm_tz').textContent = userProfile.timezone || 'UTC';
			
			// Social links
			const socialDiv = document.getElementById('pm_social');
			if (socialDiv) {
				socialDiv.innerHTML = '';
				if (userProfile.socialLinks) {
					if (userProfile.socialLinks.twitter) {
						const twitterLink = document.createElement('a');
						twitterLink.href = userProfile.socialLinks.twitter;
						twitterLink.target = '_blank';
						twitterLink.textContent = 'üê¶ Twitter';
						twitterLink.style.marginRight = '10px';
						socialDiv.appendChild(twitterLink);
					}
					if (userProfile.socialLinks.github) {
						const githubLink = document.createElement('a');
						githubLink.href = userProfile.socialLinks.github;
						githubLink.target = '_blank';
						githubLink.textContent = 'üêô GitHub';
						githubLink.style.marginRight = '10px';
						socialDiv.appendChild(githubLink);
					}
					if (userProfile.socialLinks.linkedin) {
						const linkedinLink = document.createElement('a');
						linkedinLink.href = userProfile.socialLinks.linkedin;
						linkedinLink.target = '_blank';
						linkedinLink.textContent = 'üíº LinkedIn';
						socialDiv.appendChild(linkedinLink);
					}
				}
			}
			
			// Show profile modal
			console.log('üîç Opening profile modal');
			document.getElementById('profileModal').style.display = 'block';
		};

		// Initialize everything
		checkReferral();
		
		setTimeout(() => {
			if (window.aptos) {
				// Only show connect button if wallet is not connected
				if (!walletConnected) {
					document.getElementById('connectWallet').style.display = 'block';
				}
				console.log('‚úÖ Petra wallet detected');
			} else {
				document.getElementById('connectWallet').style.display = 'block';
				document.getElementById('connectWallet').textContent = 'Install Petra Wallet';
				console.log('‚ùå Petra wallet not found');
			}
		}, 1000);

		// Profile functions
	window.selectAvatar = function(avatar) {
		window.selectedAvatar = avatar;
			document.querySelectorAll('.avatar-option').forEach(option => {
				option.style.borderColor = '#333';
			});
			document.querySelector(`[data-avatar="${avatar}"]`).style.borderColor = '#82ffa1';
		};

	window.closeCreateProfile = function() {
			document.getElementById('createProfileModal').style.display = 'none';
		};

	window.saveProfile = function() {
			const username = document.getElementById('usernameInput').value.trim();
			const bio = document.getElementById('bioInput').value.trim();
			const email = document.getElementById('emailInput').value.trim();
			const experience = document.getElementById('experienceInput').value;
			const privacy = document.querySelector('input[name="privacy"]:checked').value;
			
			// Get selected skills
			const skillCheckboxes = document.querySelectorAll('input[name="skills"]:checked');
			const skills = Array.from(skillCheckboxes).map(cb => cb.value);
			
			// Get social links
			const twitter = document.getElementById('twitterInput').value.trim();
			const github = document.getElementById('githubInput').value.trim();
			const linkedin = document.getElementById('linkedinInput').value.trim();

			// Security validation
			if (!username) {
				alert('Please enter a username!');
				return;
			}
			
			if (!email) {
				alert('Please enter your email!');
				return;
			}
			
			if (!email.includes('@')) {
				alert('Please enter a valid email address!');
				return;
			}

			if (!validateInput(username, 'username')) {
				alert('‚ùå Invalid username!\n\nUsername must be:\n‚Ä¢ 3-20 characters\n‚Ä¢ Letters, numbers, underscore, dash only');
				return;
			}

			if (!validateInput(bio, 'bio')) {
				alert('‚ùå Bio too long! Maximum 200 characters.');
				return;
			}

			// Determine avatar (custom upload or emoji)
			let avatar = window.selectedAvatar || 'üßë‚Äçüíª';
			if (window.customAvatar) {
				avatar = window.customAvatar;
			}
			
			window.userProfile = {
				avatar: avatar,
				name: username, // Add name field
				username: username,
				handle: username.toLowerCase().replace(/\s+/g, '_'), // Add handle field
				bio: bio || 'Move developer',
				email: email,
				skills: skills,
				experience: experience,
				privacy: privacy,
				socialLinks: {
					twitter: twitter,
					github: github,
					linkedin: linkedin
				},
				walletAddress: window.walletAddress,
				createdAt: new Date().toISOString(),
				questsCompleted: 0,
				streak: 0,
				badges: ['New Builder'],
				following: [],
				activities: []
			};

			localStorage.setItem('userProfile', JSON.stringify(window.userProfile));
			closeCreateProfile();
			updateWalletUI();
			alert('‚úÖ Profile created successfully!');
		};

		function updateWalletUI() {
			const connectBtn = document.getElementById('connectWallet');
			const walletInfo = document.getElementById('walletInfo');
			const addressDiv = document.getElementById('walletAddress');
			const userNameDiv = document.getElementById('userName');

			if (walletConnected && walletAddress) {
				connectBtn.style.display = 'none';
				walletInfo.style.display = 'block';
				
				// Always show wallet address
				addressDiv.textContent = walletAddress.slice(0, 6) + '...' + walletAddress.slice(-4);
				
				// Show user name separately if profile exists
				const savedProfile = localStorage.getItem('userProfile');
				if (savedProfile) {
					const profile = JSON.parse(savedProfile);
					if (profile.name || profile.username) {
						userNameDiv.textContent = profile.name || profile.username;
						userNameDiv.style.display = 'block';
					} else {
						userNameDiv.style.display = 'none';
					}
				} else {
					userNameDiv.style.display = 'none';
				}
			} else {
				connectBtn.style.display = 'block';
				walletInfo.style.display = 'none';
			}
		}

		// Close profile modal events
		document.getElementById('closeCreateProfile').addEventListener('click', (e) => {
			e.preventDefault();
			closeCreateProfile();
		});

		document.getElementById('createProfileModal').addEventListener('click', (e) => {
			if (e.target.id === 'createProfileModal') {
				closeCreateProfile();
			}
		});

		// Scroll functions for highlights
		window.scrollToQuests = function() {
			document.getElementById('exploreQuests').click();
		};

		window.scrollToMentorship = function() {
			document.getElementById('findMentorBtn').scrollIntoView({ behavior: 'smooth', block: 'center' });
		};

		window.scrollToCollaboration = function() {
			// Find "Active Collaborations" section
			const allH3 = document.querySelectorAll('h3');
			let collabSection = null;
			
			allH3.forEach(h3 => {
				if (h3.textContent.includes('üî• Active Collaborations')) {
					collabSection = h3;
				}
			});
			
			if (collabSection) {
				collabSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
			} else {
				// Fallback to first collaboration card
				const firstCollabCard = document.querySelector('[onclick*="joinCollaboration"]');
				if (firstCollabCard) {
					firstCollabCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
				}
			}
		};

		window.scrollToRewards = function() {
			document.getElementById('viewSponsorPools').scrollIntoView({ behavior: 'smooth', block: 'center' });
		};

		window.scrollToAnalytics = function() {
			document.getElementById('questChart').scrollIntoView({ behavior: 'smooth', block: 'center' });
		};

		window.scrollToProfiles = function() {
			document.getElementById('profilesGrid').scrollIntoView({ behavior: 'smooth', block: 'center' });
		};

		// Enhanced mentorship system
		document.getElementById('findMentorBtn').addEventListener('click', () => {
			if (!walletConnected) {
				alert('Please connect your wallet first!');
				return;
			}
			
			// Show mentorship modal
			const mentorList = document.getElementById('mentorList');
			const availableMentors = profiles.filter(p => p.avail.includes('Available'));
			
			mentorList.innerHTML = availableMentors.map(mentor => `
				<div style="padding:16px; border:1px solid #333; border-radius:8px; margin:12px 0; background:#0f1f0f;">
					<div style="display:flex; align-items:center; gap:12px; margin-bottom:8px;">
						<span style="font-size:24px;">üë§</span>
						<div>
							<h4 style="margin:0; color:#82ffa1;">${mentor.name}</h4>
							<p style="margin:0; font-size:12px; color:#cfcfcf;">${mentor.bio}</p>
						</div>
					</div>
					<div style="margin:8px 0;">
						${mentor.skills.map(skill => `<span class="chip">${skill}</span>`).join('')}
					</div>
					<div style="display:flex; gap:8px; margin-top:12px;">
						<button class="btn" onclick="bookMentor('${mentor.handle}', '${mentor.name}')" style="font-size:12px;">üìÖ Book Session</button>
						<span class="badge">${mentor.avail}</span>
						<span class="badge">${mentor.tz}</span>
					</div>
				</div>
			`).join('');
			
			document.getElementById('mentorshipModal').style.display = 'grid';
		});

		// Enhanced pair programming
		document.getElementById('joinPairBtn').addEventListener('click', () => {
			if (!walletConnected) {
				alert('Please connect your wallet first!');
				return;
			}
			
			document.getElementById('pairProgrammingModal').style.display = 'grid';
		});

		// Enhanced mentor booking with clickable options
		window.bookMentor = function(handle, name) {
			// Update mentor list to show session options
			const mentorList = document.getElementById('mentorList');
			mentorList.innerHTML = `
				<div style="text-align:center; margin-bottom:16px;">
					<h3 style="margin:0; color:#82ffa1;">üìÖ Book Session with ${name}</h3>
					<p style="margin:8px 0; color:#cfcfcf;">Choose your preferred session type:</p>
				</div>
				
				<div style="padding:12px; border:1px solid #333; border-radius:8px; margin:8px 0; cursor:pointer; transition:all 0.2s ease;" onclick="confirmBooking('${name}', 'intro')" onmouseover="this.style.borderColor='#82ffa1'" onmouseout="this.style.borderColor='#333'">
					<strong>Introduction Session</strong><br>
					<small>30 minutes ‚Ä¢ Free ‚Ä¢ Perfect for beginners</small>
				</div>
				
				<div style="padding:12px; border:1px solid #333; border-radius:8px; margin:8px 0; cursor:pointer; transition:all 0.2s ease;" onclick="confirmBooking('${name}', 'deep')" onmouseover="this.style.borderColor='#82ffa1'" onmouseout="this.style.borderColor='#333'">
					<strong>Deep Dive Session</strong><br>
					<small>1 hour ‚Ä¢ 0.1 APT ‚Ä¢ Advanced topics & code review</small>
				</div>
				
				<div style="padding:12px; border:1px solid #333; border-radius:8px; margin:8px 0; cursor:pointer; transition:all 0.2s ease;" onclick="confirmBooking('${name}', 'project')" onmouseover="this.style.borderColor='#82ffa1'" onmouseout="this.style.borderColor='#333'">
					<strong>Project Review</strong><br>
					<small>45 minutes ‚Ä¢ 0.15 APT ‚Ä¢ Portfolio & project feedback</small>
				</div>
				
				<div style="text-align:center; margin-top:16px;">
					<button class="btn secondary" onclick="location.reload()" style="font-size:12px;">‚Üê Back to Mentors</button>
				</div>
			`;
		};

		// Confirm booking function
		window.confirmBooking = function(mentorName, sessionType) {
			const sessions = {
				'intro': 'Introduction Session (30 min) - Free',
				'deep': 'Deep Dive Session (1 hour) - 0.1 APT',
				'project': 'Project Review (45 min) - 0.15 APT'
			};
			
			document.getElementById('mentorshipModal').style.display = 'none';
			alert(`‚úÖ Session booked with ${mentorName}!\n\nüìÖ ${sessions[sessionType]}\nüìß Calendar invite sent to your email\nüí¨ Mentor will contact you within 24h`);
		};

		// Pair session joining
		window.joinPairSession = function(sessionId) {
			const sessions = [
				'Quest 1: Basic Move Syntax',
				'Quest 3: Resource Model', 
				'Custom DeFi Project'
			];
			
			document.getElementById('pairProgrammingModal').style.display = 'none';
			alert(`‚úÖ Joined "${sessions[sessionId-1]}" session!\n\nYou'll be matched with other developers shortly.\nDiscord invite sent!`);
		};

		// Modal close handlers
		document.getElementById('closeMentorship').addEventListener('click', (e) => {
			e.preventDefault();
			document.getElementById('mentorshipModal').style.display = 'none';
		});

		document.getElementById('closePairProgramming').addEventListener('click', (e) => {
			e.preventDefault();
			document.getElementById('pairProgrammingModal').style.display = 'none';
		});

		document.getElementById('viewHackathonsBtn').addEventListener('click', () => {
			if (!walletConnected) {
				alert('Please connect your wallet first!');
				return;
			}
			
			// Show hackathon modal instead of prompt
			document.getElementById('hackathonModal').style.display = 'grid';
		});

		// Hackathon registration function
		window.registerHackathon = function(hackathonType) {
			const hackathons = {
				'defi': 'Move DeFi Challenge (Jan 15-17, 2025)',
				'nft': 'NFT Innovation Sprint (Jan 22-24, 2025)'
			};
			
			document.getElementById('hackathonModal').style.display = 'none';
			alert(`üéâ Registered for ${hackathons[hackathonType]}!\n\n‚úÖ Registration confirmed\nüìß Details sent to your email\nüí¨ Discord invite coming soon`);
		};

		document.getElementById('viewSponsorPools').addEventListener('click', () => {
			alert('üí∞ Active Sponsor Pools:\n\nüè¶ Aptos Foundation - 1000 APT (65% distributed)\nüîä Decibel - 750 APT (45% distributed)\n‚ö° Shelby Protocol - 400 APT (30% distributed)\n\nScroll down to join pools!');
		});

		document.getElementById('leaderboardBtn').addEventListener('click', () => {
			alert('üèÜ Current Leaderboard:\n\n1. @nese - 35 quests ‚Ä¢ 1.4 APT\n2. @dilek - 29 quests ‚Ä¢ 1.1 APT\n3. @selina - 22 quests ‚Ä¢ 0.7 APT\n4. @deniz - 20 quests ‚Ä¢ 0.6 APT\n5. @efecan - 18 quests ‚Ä¢ 0.5 APT');
		});

		document.getElementById('verifyRewards').addEventListener('click', () => {
			if (!walletConnected) {
				alert('Please connect your wallet first!');
				return;
			}
			alert('‚úÖ Your Verified Rewards:\n\nQuest Completions: 0\nTotal Earned: 0 APT\nOn-Chain Transactions: 0\n\nComplete quests to start earning!');
		});

		// Debug function to clear avatar data
		window.clearAvatarData = function() {
			const savedProfile = localStorage.getItem('userProfile');
			if (savedProfile) {
				const userProfile = JSON.parse(savedProfile);
				console.log('üîç Current avatar data:', userProfile.avatar);
				userProfile.avatar = null;
				localStorage.setItem('userProfile', JSON.stringify(userProfile));
				console.log('‚úÖ Avatar data cleared');
				alert('Avatar data cleared! Please upload a new avatar.');
			}
		};

		// Function to fix broken avatar data
		window.fixAvatarData = function() {
			// Clear all localStorage data
			localStorage.removeItem('userProfile');
			console.log('‚úÖ All profile data cleared');
			alert('All profile data cleared! Please refresh the page and create a new profile.');
		};

		// Function to check and fix avatar display issues
		window.checkAvatarIssues = function() {
			const savedProfile = localStorage.getItem('userProfile');
			if (savedProfile) {
				const userProfile = JSON.parse(savedProfile);
				console.log('üîç Profile data:', userProfile);
				console.log('üîç Avatar type:', typeof userProfile.avatar);
				console.log('üîç Avatar length:', userProfile.avatar ? userProfile.avatar.length : 'null');
				
				if (userProfile.avatar && userProfile.avatar.length > 1000) {
					console.log('‚ö†Ô∏è Avatar data is too long, might be corrupted');
					userProfile.avatar = null;
					localStorage.setItem('userProfile', JSON.stringify(userProfile));
					console.log('‚úÖ Corrupted avatar data cleared');
					alert('Corrupted avatar data detected and cleared!');
				}
			}
		};

		// Emergency function to completely clear all avatar data
		window.emergencyClearAvatar = function() {
			// Clear all localStorage
			localStorage.clear();
			console.log('üö® Emergency: All localStorage cleared');
			alert('üö® Emergency: All data cleared! Please refresh the page.');
			location.reload();
		};

		// Function to force clear just avatar data
		window.forceClearAvatar = function() {
			const savedProfile = localStorage.getItem('userProfile');
			if (savedProfile) {
				const userProfile = JSON.parse(savedProfile);
				userProfile.avatar = null;
				localStorage.setItem('userProfile', JSON.stringify(userProfile));
				console.log('‚úÖ Avatar data force cleared');
				alert('Avatar data cleared! Refreshing page...');
				location.reload();
			} else {
				alert('No profile found to clear');
			}
		};

		// Global functions
		window.joinCollaboration = function(projectId) {
			if (!walletConnected) {
				alert('Please connect your wallet first!');
				return;
			}
			alert(`‚úÖ Application sent for ${projectId}! Team lead will contact you via email.`);
		};

		window.joinSponsorPool = function(poolId) {
			if (!walletConnected) {
				alert('Please connect your wallet first!');
				return;
			}
			alert(`‚úÖ Joined ${poolId} sponsor pool! Start completing quests to earn rewards.`);
		};

		// Chart rendering
		function updateQuestChart() {
			const canvas = document.getElementById('questChart');
			if (!canvas) return;
			
			const ctx = canvas.getContext('2d');
			const width = canvas.width;
			const height = canvas.height;
			
			// Clear canvas
			ctx.fillStyle = '#0f0f0f';
			ctx.fillRect(0, 0, width, height);
			
			// Draw simple chart
			const data = [12, 19, 15, 25, 32, 28, 35];
			const maxValue = Math.max(...data);
			const barWidth = width / data.length;
			
			ctx.fillStyle = '#82ffa1';
			data.forEach((value, index) => {
				const barHeight = (value / maxValue) * (height - 20);
				const x = index * barWidth + 5;
				const y = height - barHeight - 10;
				ctx.fillRect(x, y, barWidth - 10, barHeight);
			});
		}

		// Update stats periodically
		function updateStats() {
			document.getElementById('activeDevelopers').textContent = Math.floor(Math.random() * 20) + 120;
			document.getElementById('completedQuests').textContent = Math.floor(Math.random() * 30) + 80;
			document.getElementById('onChainTx').textContent = Math.floor(Math.random() * 50) + 140;
		}

		// Enhanced social sharing function
		window.shareAchievement = function(questTitle, txHash = null) {
			let shareText;
			
			if (txHash) {
				// On-chain achievement with transaction hash
				shareText = `üéâ Just completed "${questTitle}" on @movebuildershub!\n\n‚õìÔ∏è On-chain proof: ${txHash.slice(0, 16)}...\nüöÄ Learning Move programming on Aptos blockchain\n\nüîó Join me: https://movebuildershub.xyz\n\n#Move #Aptos #Web3Education #Blockchain #OnChain`;
			} else {
				// Regular achievement
				shareText = `üéâ Just completed "${questTitle}" on @movebuildershub!\n\nLearning Move programming on-chain üöÄ\n\nüîó Join me: https://movebuildershub.xyz\n\n#Move #Aptos #Web3Education #Blockchain`;
			}
			
			if (navigator.share && isMobile()) {
				// Native mobile sharing
				navigator.share({ 
					title: 'Move Builders Hub Achievement', 
					text: shareText, 
					url: 'https://movebuildershub.xyz' 
				});
			} else {
				// Desktop: Show sharing options
				const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}`;
				const linkedInUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent('https://movebuildershub.xyz')}&summary=${encodeURIComponent(shareText)}`;
				
				const choice = confirm(`üì§ Share "${questTitle}" Achievement!\n\nClick OK for X (Twitter)\nClick Cancel to copy text for manual sharing`);
				
				if (choice) {
					// Open X (Twitter)
					window.open(twitterUrl, '_blank', 'width=600,height=400');
				} else {
					// Copy to clipboard + show more options
					navigator.clipboard.writeText(shareText).then(() => {
						const moreOptions = confirm(`üìã Text copied to clipboard!\n\nClick OK to open LinkedIn sharing\nClick Cancel to share manually`);
						
						if (moreOptions) {
							window.open(linkedInUrl, '_blank', 'width=600,height=400');
						}
					});
				}
			}
		};

		// Achievement system
		function awardAchievements(questId) {
			if (!userProfile) return;
			
			const newBadges = [];
			userProfile.questsCompleted = (userProfile.questsCompleted || 0) + 1;
			userProfile.streak = (userProfile.streak || 0) + 1;
			
			// Milestone badges
			if (userProfile.questsCompleted === 1) newBadges.push('First Quest');
			if (userProfile.questsCompleted === 3) newBadges.push('Getting Started');
			if (userProfile.questsCompleted === 6) newBadges.push('Quest Master');
			if (userProfile.streak === 3) newBadges.push('On Fire');
			
			// Quest-specific badges
			if (questId === 3) newBadges.push('Security Expert');
			if (questId === 5) newBadges.push('Module Architect');
			
			newBadges.forEach(badge => {
				if (!userProfile.badges) userProfile.badges = ['New Builder'];
				if (!userProfile.badges.includes(badge)) {
					userProfile.badges.push(badge);
				}
			});
			
			localStorage.setItem(`profile_${walletAddress}`, JSON.stringify(userProfile));
			
			if (newBadges.length > 0) {
				setTimeout(() => {
					alert(`üèÜ New Achievement!\n\nBadges earned: ${newBadges.join(', ')}\n\nTotal quests: ${userProfile.questsCompleted}\nStreak: ${userProfile.streak} days`);
				}, 2000);
			}
		}

		// Enhanced quest completion with sharing and achievements
		async function completeQuestWithSharing(questId, questTitle) {
			try {
				// Check wallet connection
				if (!window.walletConnected || !window.walletAddress) {
					alert('‚ùå Please connect your wallet first to complete quests on-chain!');
					return;
				}

				// Show loading state with transaction details
				const questFee = 0.000001; // 0.000001 APT
				const loadingMsg = `üîÑ Completing quest "${questTitle}" on-chain...\n\nüí∞ Transaction Fee: ${questFee} APT\n‚è≥ Please approve the transaction in your wallet`;
				alert(loadingMsg);

				// Create quest completion transaction
				const questCompletionTx = await createQuestCompletionTransaction(questId, questTitle);
				
				// Submit transaction to blockchain
				const response = await window.aptos.signAndSubmitTransaction(questCompletionTx);
				
				console.log('üéØ Quest completion transaction:', response);
				
				// Wait for transaction confirmation
				await window.aptos.waitForTransaction(response.hash);
				
				// Award achievements after successful on-chain completion
				awardAchievements(questId);
				
				// Update local storage with on-chain proof
				updateQuestProgressOnChain(questId, response.hash);
				
				alert(`üéâ Quest "${questTitle}" completed on-chain!\n\n‚úÖ Transaction Hash: ${response.hash.slice(0, 16)}...\nüí∞ Fee Paid: 0.000001 APT\n‚õìÔ∏è Recorded on Aptos blockchain\nüèÜ Achievement earned\n\nüîó View on Explorer: https://explorer.aptoslabs.com/txn/${response.hash}`);
				
				setTimeout(() => {
					const share = confirm('üì§ Share your on-chain achievement on social media?');
					if (share) {
						shareAchievement(questTitle, response.hash);
					}
				}, 1000);

			} catch (error) {
				console.error('‚ùå Quest completion failed:', error);
				
				if (error.message.includes('User rejected')) {
					alert('‚ùå Quest completion cancelled. Transaction was rejected.');
				} else if (error.message.includes('Insufficient')) {
					alert('‚ùå Insufficient balance for quest completion transaction.');
				} else {
					alert(`‚ùå Quest completion failed: ${error.message}\n\nPlease try again or check your wallet connection.`);
				}
			}
		}

		// Create quest completion transaction
		async function createQuestCompletionTransaction(questId, questTitle) {
			// Get current network
			const network = await window.aptos.network();
			console.log('üåê Current network:', network);

			// Quest completion data
			const questData = {
				questId: questId,
				questTitle: questTitle,
				timestamp: Date.now(),
				userAddress: window.walletAddress,
				completionProof: `quest_${questId}_${Date.now()}`
			};

			// Create a real quest completion transaction
			// We'll use a simple transfer to a quest completion address with memo
			const questCompletionAddress = "0x1"; // Burn address for quest completion
			const questFee = 1000; // 0.000001 APT (very small fee for quest completion)
			
			const transaction = {
				arguments: [
					questCompletionAddress, // Quest completion address
					questFee.toString() // Small fee for quest completion
				],
				function: "0x1::aptos_account::transfer",
				type: "entry_function_payload",
				type_arguments: ["0x1::aptos_coin::AptosCoin"]
			};

			console.log('üéØ Quest completion transaction:', transaction);
			console.log('üìù Quest data:', questData);

			return transaction;
		}

		// Update quest progress with on-chain proof
		function updateQuestProgressOnChain(questId, txHash) {
			// Get current progress
			let progress = JSON.parse(localStorage.getItem('questProgress') || '{}');
			
			// Update with on-chain proof
			progress[questId] = {
				completed: true,
				completedAt: new Date().toISOString(),
				txHash: txHash,
				onChain: true,
				verified: true
			};
			
			// Save back to localStorage
			localStorage.setItem('questProgress', JSON.stringify(progress));
			
			// Update user profile with on-chain quest count
			const profile = JSON.parse(localStorage.getItem('userProfile') || '{}');
			if (profile.questsCompleted) {
				profile.questsCompleted++;
			} else {
				profile.questsCompleted = 1;
			}
			
			// Add on-chain proof to profile
			if (!profile.onChainProofs) {
				profile.onChainProofs = [];
			}
			profile.onChainProofs.push({
				type: 'quest_completion',
				questId: questId,
				txHash: txHash,
				timestamp: new Date().toISOString()
			});
			
			localStorage.setItem('userProfile', JSON.stringify(profile));
			
			console.log('‚úÖ Quest progress updated with on-chain proof:', txHash);
		}

		// Show quest progress with on-chain verification
		window.showQuestProgress = function() {
			const progress = JSON.parse(localStorage.getItem('questProgress') || '{}');
			const profile = JSON.parse(localStorage.getItem('userProfile') || '{}');
			
			let progressHtml = '<div style="padding:20px; max-height:400px; overflow-y:auto;">';
			progressHtml += '<h3>üéØ Quest Progress & On-Chain Proofs</h3>';
			
			if (Object.keys(progress).length === 0) {
				progressHtml += '<p style="color:#8a8a8a; text-align:center; margin:20px 0;">No quests completed yet.</p>';
			} else {
				progressHtml += '<div style="display:grid; gap:12px; margin-top:16px;">';
				
				Object.entries(progress).forEach(([questId, questData]) => {
					const quest = window.quests.find(q => q.id == questId);
					const questTitle = quest ? quest.title : `Quest ${questId}`;
					
					progressHtml += `
						<div style="background:#1a1a1a; padding:16px; border-radius:8px; border:1px solid #333;">
							<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
								<h4 style="margin:0; color:#82ffa1;">${questTitle}</h4>
								${questData.onChain ? '<span style="background:#82ffa1; color:#000; padding:2px 8px; border-radius:4px; font-size:11px;">‚õìÔ∏è ON-CHAIN</span>' : '<span style="background:#666; color:#fff; padding:2px 8px; border-radius:4px; font-size:11px;">üì± LOCAL</span>'}
							</div>
							<div style="font-size:12px; color:#8a8a8a;">
								<div>‚úÖ Completed: ${new Date(questData.completedAt).toLocaleDateString()}</div>
								${questData.txHash ? `<div>üîó TX Hash: <code style="background:#222; padding:2px 4px; border-radius:3px;">${questData.txHash.slice(0, 16)}...</code></div>` : ''}
								${questData.onChain ? '<div>üí∞ Fee Paid: 0.000001 APT</div>' : ''}
								${questData.verified ? '<div>‚úÖ Verified on Aptos blockchain</div>' : ''}
								${questData.txHash ? `<div>üîç <a href="https://explorer.aptoslabs.com/txn/${questData.txHash}" target="_blank" style="color:#82ffa1;">View on Explorer</a></div>` : ''}
							</div>
						</div>
					`;
				});
				
				progressHtml += '</div>';
			}
			
			// Show on-chain proofs summary
			if (profile.onChainProofs && profile.onChainProofs.length > 0) {
				progressHtml += '<div style="margin-top:20px; padding:16px; background:#0a2a0a; border-radius:8px; border:1px solid #82ffa1;">';
				progressHtml += '<h4 style="margin:0 0 12px 0; color:#82ffa1;">‚õìÔ∏è On-Chain Proofs Summary</h4>';
				progressHtml += `<div style="font-size:14px; color:#8a8a8a;">Total on-chain quests: <strong style="color:#82ffa1;">${profile.onChainProofs.length}</strong></div>`;
				progressHtml += `<div style="font-size:12px; color:#8a8a8a; margin-top:8px;">All quest completions are verified and recorded on Aptos blockchain</div>`;
				progressHtml += '</div>';
			}
			
			progressHtml += '</div>';
			
			// Show in modal
			document.getElementById('modalContent').innerHTML = progressHtml;
			document.getElementById('modal').style.display = 'block';
		};

		// Daily streaks system
		function checkDailyLogin() {
			if (!userProfile) return;
			
			const today = new Date().toDateString();
			const lastLogin = userProfile.lastLogin;
			
			if (lastLogin !== today) {
				const yesterday = new Date();
				yesterday.setDate(yesterday.getDate() - 1);
				
				if (lastLogin === yesterday.toDateString()) {
					// Consecutive day
					userProfile.streak = (userProfile.streak || 0) + 1;
					
					if (userProfile.streak % 7 === 0) {
						alert(`üî• ${userProfile.streak} Day Streak!\n\nBonus: +50 XP\nKeep the momentum going!`);
						userProfile.xp = (userProfile.xp || 0) + 50;
					}
				} else {
					// Streak broken
					if (userProfile.streak > 0) {
						alert(`üìÖ Welcome back!\n\nPrevious streak: ${userProfile.streak} days\nStarting fresh today!`);
					}
					userProfile.streak = 1;
				}
				
				userProfile.lastLogin = today;
				localStorage.setItem(`profile_${walletAddress}`, JSON.stringify(userProfile));
			}
		}

		// Push notifications setup
		async function setupPushNotifications() {
			if ('serviceWorker' in navigator && 'PushManager' in window) {
				try {
					// Register service worker
					const registration = await navigator.serviceWorker.register('/sw.js');
					console.log('‚úÖ Service Worker registered');
					
					// Request notification permission
					const permission = await Notification.requestPermission();
					if (permission === 'granted') {
						notificationPermission = true;
						console.log('‚úÖ Notification permission granted');
						
						// Schedule daily reminder
						scheduleQuestReminder();
					}
				} catch (error) {
					console.log('‚ùå Push notifications not supported');
				}
			}
		}

		function scheduleQuestReminder() {
			if (!notificationPermission) return;
			
			// Daily reminder at 6 PM
			const now = new Date();
			const reminderTime = new Date();
			reminderTime.setHours(18, 0, 0, 0);
			
			if (reminderTime < now) {
				reminderTime.setDate(reminderTime.getDate() + 1);
			}
			
			const timeUntilReminder = reminderTime.getTime() - now.getTime();
			
			setTimeout(() => {
				if (Notification.permission === 'granted') {
					new Notification('üéØ Daily Quest Reminder', {
						body: 'Complete a quest to maintain your streak!',
						icon: '/logo.png',
						badge: '/logo.png'
					});
				}
				
				// Schedule next day
				scheduleQuestReminder();
			}, timeUntilReminder);
		}

		// Input validation and security
		function validateInput(input, type) {
			if (type === 'username') {
				return input.length >= 3 && input.length <= 20 && /^[a-zA-Z0-9_-]+$/.test(input);
			}
			if (type === 'bio') {
				return input.length <= 200;
			}
			return true;
		}

		// Initialize charts and stats
		setTimeout(() => {
			updateQuestChart();
			updateStats();
			setInterval(updateStats, 30000); // Update every 30 seconds
			
		}, 1000);

		// Personal dashboard functionality
		document.getElementById('myDashboard').addEventListener('click', () => {
			if (!walletConnected || !userProfile) {
				alert('Please connect wallet and create profile first!');
				return;
			}
			
			// Update dashboard data
			document.getElementById('userQuestsCompleted').textContent = userProfile.questsCompleted || 0;
			document.getElementById('userStreak').textContent = userProfile.streak || 0;
			document.getElementById('userLevel').textContent = Math.floor((userProfile.questsCompleted || 0) / 2) + 1;
			document.getElementById('userXP').textContent = (userProfile.questsCompleted || 0) * 100 + (userProfile.xp || 0);
			
			// Show badges
			const badgesDiv = document.getElementById('userBadges');
			badgesDiv.innerHTML = (userProfile.badges || []).map(badge => `<span class="chip">${badge}</span>`).join('');
			
			document.getElementById('personalDashboardModal').style.display = 'grid';
		});

		// Code editor functionality - removed duplicate viewStats listener

		// Code templates
		window.loadTemplate = function(type) {
			const editor = document.getElementById('moveCodeEditor');
			const templates = {
				basic: `module 0x1::basic_example {
    public fun add(a: u64, b: u64): u64 {
        a + b
    }
    
    public fun greet(name: vector<u8>): vector<u8> {
        b"Hello, " + name + b"!"
    }
}`,
				coin: `module 0x1::my_coin {
    struct Coin has store {
        value: u64,
    }
    
    public fun mint(amount: u64): Coin {
        Coin { value: amount }
    }
    
    public fun burn(coin: Coin): u64 {
        let Coin { value } = coin;
        value
    }
}`,
				defi: `module 0x1::simple_pool {
    struct Pool has key {
        token_a: u64,
        token_b: u64,
        shares: u64,
    }
    
    public entry fun create_pool(
        account: &signer,
        amount_a: u64,
        amount_b: u64
    ) {
        move_to(account, Pool {
            token_a: amount_a,
            token_b: amount_b,
            shares: 1000,
        });
    }
}`
			};
			
			editor.value = templates[type];
		};

		// Run Move code (simulation)
		window.runMoveCode = function() {
			const code = document.getElementById('moveCodeEditor').value;
			const output = document.getElementById('codeOutput');
			
			output.innerHTML = '<div class="spinner"></div> Compiling Move code...';
			
			setTimeout(() => {
				if (code.includes('syntax error') || code.includes('error')) {
					output.innerHTML = '<div style="color:#ff6b6b;">‚ùå Compilation Error: Check your syntax</div>';
				} else {
					output.innerHTML = `<div style="color:#82ffa1;">‚úÖ Compilation Successful!</div>
					<div style="margin-top:8px; color:#cfcfcf;">
						‚Ä¢ Module compiled successfully<br>
						‚Ä¢ Functions validated<br>
						‚Ä¢ Ready for deployment to Aptos testnet
					</div>`;
				}
			}, 2000);
		};

		// Modal close handlers
		document.getElementById('closeDashboard').addEventListener('click', (e) => {
			e.preventDefault();
			document.getElementById('personalDashboardModal').style.display = 'none';
		});

		document.getElementById('closeCodeEditor').addEventListener('click', (e) => {
			e.preventDefault();
			document.getElementById('codeEditorModal').style.display = 'none';
		});

		document.getElementById('closeHackathon').addEventListener('click', (e) => {
			e.preventDefault();
			document.getElementById('hackathonModal').style.display = 'none';
		});

		document.getElementById('connectWallet').addEventListener('click', connectWallet);
		document.getElementById('disconnectWallet').addEventListener('click', disconnectWallet);
		
		// Chat modal event listeners
		document.getElementById('closeChat').addEventListener('click', (e) => {
			e.preventDefault();
			document.getElementById('chatModal').style.display = 'none';
		});
		
		// Enter key to send message
		document.addEventListener('keypress', (e) => {
			if (e.key === 'Enter' && document.getElementById('messageInput') === document.activeElement) {
				sendMessage();
			}
		});
	
	// Global variables for messaging
	window.currentChatUser = null;
	window.messages = [];
	window.gasFee = 0.001;
	
	// Like quest function
	window.likeQuest = function(questId, reaction) {
		const quest = quests.find(q => q.id === questId);
		if (!quest) return;
		
		// Initialize reaction counts if not exists
		if (!quest.likes) quest.likes = 0;
		if (!quest.fire) quest.fire = 0;
		if (!quest.rocket) quest.rocket = 0;
		
		// Update reaction count
		if (reaction === '‚ù§Ô∏è') {
			quest.likes++;
			document.getElementById(`likes-${questId}`).textContent = quest.likes;
		} else if (reaction === 'üî•') {
			quest.fire++;
			document.getElementById(`fire-${questId}`).textContent = quest.fire;
		} else if (reaction === 'üöÄ') {
			quest.rocket++;
			document.getElementById(`rocket-${questId}`).textContent = quest.rocket;
		}
		
		// Show feedback
		const button = event.target.closest('button');
		button.style.background = '#82ffa1';
		button.style.color = '#000';
		setTimeout(() => {
			button.style.background = 'transparent';
			button.style.color = '#fff';
		}, 1000);
	};
	
	// Toggle follow function
	window.toggleFollow = function(userHandle) {
		if (!window.userProfile) {
			alert('Please create a profile first!');
			return;
		}
		
		if (!window.userProfile.following) window.userProfile.following = [];
		
		const followBtn = document.getElementById(`followBtn_${userHandle}`);
		
		if (window.userProfile.following.includes(userHandle)) {
			// Unfollow
			window.userProfile.following = window.userProfile.following.filter(u => u !== userHandle);
			
			// Update button
			if (followBtn) {
				followBtn.textContent = 'Follow';
				followBtn.classList.remove('btn');
				followBtn.classList.add('btn', 'secondary');
			}
		} else {
			// Follow
			window.userProfile.following.push(userHandle);
			
			// Update button
			if (followBtn) {
				followBtn.textContent = 'Followed';
				followBtn.classList.remove('btn', 'secondary');
				followBtn.classList.add('btn');
			}
		}
		
		// Save to localStorage
		localStorage.setItem(`profile_${window.walletAddress}`, JSON.stringify(window.userProfile));
	};
	
	// Open chat function
	window.openChat = function(userHandle, userName) {
		if (!window.userProfile) {
			alert('Please create a profile first!');
			return;
		}
		
		if (!window.walletConnected) {
			alert('Please connect your wallet first!');
			return;
		}
		
		window.currentChatUser = userHandle;
		document.getElementById('chatTitle').textContent = `üí¨ Chat with ${userName}`;
		
		// Load gas fee
		updateGasFee();
		
		// Load messages
		loadMessages();
		
		// Show transaction info
		document.getElementById('transactionInfo').style.display = 'block';
		
		document.getElementById('chatModal').style.display = 'grid';
	};
	
	// Update gas fee function
	window.updateGasFee = async function() {
		try {
			// Simulate network status check
			const networkStatus = Math.random();
			let status, fee;
			
			if (networkStatus < 0.3) {
				status = 'Low';
				fee = 0.1; // Much higher minimum fee
			} else if (networkStatus < 0.7) {
				status = 'Normal';
				fee = 0.2;
			} else if (networkStatus < 0.9) {
				status = 'High';
				fee = 0.5;
			} else {
				status = 'Very High';
				fee = 1.0;
			}
			
			window.gasFee = fee;
			document.getElementById('chatGasInfo').textContent = `Gas Fee: ${fee} APT (${status})`;
			document.getElementById('gasFeeDisplay').textContent = `Gas: ${fee} APT`;
			document.getElementById('networkStatus').textContent = `Network: ${status}`;
			
		} catch (error) {
			console.error('Error updating gas fee:', error);
			document.getElementById('chatGasInfo').textContent = 'Gas Fee: 0.001 APT (Default)';
		}
	};
	
	// Load messages function
	window.loadMessages = function() {
		if (!window.currentChatUser) return;
		
		// Load messages from localStorage
		const chatKey = `chat_${window.walletAddress}_${window.currentChatUser}`;
		const storedMessages = localStorage.getItem(chatKey);
		window.messages = storedMessages ? JSON.parse(storedMessages) : [];
		
		// Display messages
		const container = document.getElementById('chatMessages');
		if (window.messages.length === 0) {
			container.innerHTML = '<p style="text-align:center; color:#8a8a8a; margin:20px 0;">No messages yet. Start the conversation!</p>';
		} else {
			container.innerHTML = window.messages.map(msg => `
				<div style="display:flex; ${msg.sender === window.userProfile.username ? 'justify-content:flex-end' : 'justify-content:flex-start'}; margin-bottom:12px;">
					<div style="max-width:70%; padding:8px 12px; border-radius:12px; background:${msg.sender === window.userProfile.username ? '#82ffa1' : '#333'}; color:${msg.sender === window.userProfile.username ? '#000' : '#fff'};">
						<div style="font-size:12px; opacity:0.7; margin-bottom:4px;">${msg.sender}</div>
						<div>${msg.content}</div>
						<div style="font-size:10px; opacity:0.6; margin-top:4px;">${new Date(msg.timestamp).toLocaleTimeString()}</div>
					</div>
				</div>
			`).join('');
		}
		
		// Update message count
		document.getElementById('messageCount').textContent = `${window.messages.length} messages`;
		
		// Scroll to bottom
		container.scrollTop = container.scrollHeight;
	};
	
	// Send message function
	window.sendMessage = async function() {
		const messageInput = document.getElementById('messageInput');
		const content = messageInput.value.trim();
		
		if (!content) return;
		if (!window.currentChatUser) return;
		if (!window.userProfile) return;
		
		// Show loading state
		const sendBtn = document.getElementById('sendMessageBtn');
		sendBtn.innerHTML = '‚è≥ Sending...';
		sendBtn.disabled = true;
		
		try {
			// Real wallet transaction
			await sendMessageTransaction(content);
			
			// Add message to local storage
			const newMessage = {
				id: Date.now(),
				sender: window.userProfile.username,
				content: content,
				timestamp: new Date().toISOString(),
				gasFee: window.gasFee,
				recipient: window.currentChatUser
			};
			
			window.messages.push(newMessage);
			const chatKey = `chat_${window.walletAddress}_${window.currentChatUser}`;
			localStorage.setItem(chatKey, JSON.stringify(window.messages));
			
			// Clear input and reload messages
			messageInput.value = '';
			loadMessages();
			
			// Update gas fee for next message
			updateGasFee();
			
		} catch (error) {
			console.error('Error sending message:', error);
			alert('Failed to send message. Please try again.');
		} finally {
			sendBtn.innerHTML = 'Send';
			sendBtn.disabled = false;
		}
	};
	
	// Simulate wallet transaction for messaging
	window.simulateMessageTransaction = async function(content) {
		// Simulate transaction delay
		await new Promise(resolve => setTimeout(resolve, 2000));
		
		// Simulate gas fee deduction
		console.log(`üí∏ Gas fee deducted: ${window.gasFee} APT`);
		console.log(`üìù Message: "${content}"`);
		console.log(`‚úÖ Transaction simulated successfully`);
		
		return "simulated_tx_hash_" + Date.now();
	};
	
	// Real wallet transaction for messaging
	window.sendMessageTransaction = async function(content) {
		console.log('üîç Checking Petra wallet...');
		console.log('window.aptos:', window.aptos);
		console.log('window.walletConnected:', window.walletConnected);
		console.log('window.walletAddress:', window.walletAddress);
		
		// Check if Petra wallet is installed
		if (typeof window.aptos === 'undefined') {
			alert('Petra wallet not found! Please install Petra wallet first.');
			throw new Error('Petra wallet not found. Please install Petra wallet.');
		}
		
		// Check if wallet is connected
		if (!window.walletConnected) {
			alert('Wallet not connected! Please connect your wallet first.');
			throw new Error('Wallet not connected. Please connect your wallet first.');
		}
		
		// Check network - should be testnet
		try {
			const network = await window.aptos.network();
			console.log('Current network:', network);
			
			if (network !== 'testnet') {
				const switchNetwork = confirm(`‚ö†Ô∏è You're on ${network} network!\n\nThis app works on Aptos Testnet.\n\nSwitch to Testnet now?`);
				if (switchNetwork) {
					await window.aptos.switchNetwork('testnet');
					alert('‚úÖ Switched to Testnet! Please try again.');
					return;
				} else {
					throw new Error('Please switch to Testnet to use this feature.');
				}
			}
		} catch (error) {
			console.log('Network check failed:', error);
			// Continue anyway if network check fails
		}
		
		try {
			// Confirm transaction with user
			const confirmed = confirm(`Send message with gas fee: ${window.gasFee} APT\n\nMessage: "${content}"\n\nApprove transaction?`);
			if (!confirmed) {
				throw new Error('Transaction cancelled by user');
			}
			
			console.log('üöÄ Starting transaction...');
			console.log('Amount:', Math.floor(window.gasFee * 100000000));
			
			// Create real transaction using signAndSubmitTransaction
			console.log('Creating real transaction...');
			
			const transaction = {
				arguments: [
					"0x1", // Burn address
					Math.floor(window.gasFee * 100000000).toString() // Amount in octas
				],
				function: "0x1::coin::transfer",
				type: "entry_function_payload",
				type_arguments: ["0x1::aptos_coin::AptosCoin"]
			};
			
			console.log('Transaction data:', transaction);
			
			// Submit transaction - this should open Petra wallet
			const response = await window.aptos.signAndSubmitTransaction(transaction);
			
			console.log('üìù Transaction response:', response);
			
			// Get transaction hash
			const txHash = response.hash || response.transaction?.hash || "tx_" + Date.now();
			
			console.log('‚úÖ Message transaction successful:', txHash);
			return txHash;
			
		} catch (error) {
			console.error('‚ùå Message transaction failed:', error);
			console.error('Error details:', error.message);
			alert('Transaction failed: ' + error.message);
			throw error;
		}
	};
	</script>
</body>
</html>
